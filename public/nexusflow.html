<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NexusFlow - Project Management</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
  <!-- PDF Export Libraries (used elsewhere in app) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
    }

    .material-icons-outlined {
      font-size: 20px;
    }

    .modal-content {
      animation: slideUp 0.3s ease-out forwards;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .overflow-x-auto::-webkit-scrollbar {
      height: 8px;
    }

    .overflow-x-auto::-webkit-scrollbar-track {
      background: transparent;
    }

    .overflow-x-auto::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 4px;
    }

    .overflow-x-auto::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }

    .highlight {
      animation: highlight-fade 2.5s ease-out;
    }

    @keyframes highlight-fade {

      0%,
      10% {
        background: #fef08a;
        color: #1f2937;
      }

      100% {
        background: #374151;
        color: #e5e7eb;
      }
    }

    #csvGrid table {
      border-collapse: collapse;
      width: 100%;
    }

    #csvGrid th,
    #csvGrid td {
      border: 1px solid #4b5563;
      padding: 8px;
      text-align: left;
    }

    #csvGrid th {
      background: #374151;
    }

    #csvGrid td:focus {
      outline: 2px solid #2563eb;
      background: #1e293b;
    }

    .toggle-checkbox:checked {
      background: #2563eb;
    }

    .toggle-checkbox:checked::before {
      transform: translateX(100%);
      border-color: #2563eb;
    }

    .calendar-day {
      min-height: 120px;
    }

    /* Drag and drop styles */
    .task-card.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }

    /* Task card container constraints */
    .task-card {
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .task-card .task-content {
      max-width: 100%;
      overflow: hidden;
    }

    .task-card p {
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }

    .column {
      max-width: 100%;
      overflow-x: hidden;
    }

    .tasks-container {
      max-width: 100%;
      overflow-x: hidden;
      /* Hide scrollbar but keep scroll behavior */
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* Internet Explorer 10+ */
    }

    .tasks-container::-webkit-scrollbar {
      display: none;
      /* WebKit browsers */
    }

    /* Hide scrollbar for the main kanban board */
    #kanbanBoardView {
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* Internet Explorer 10+ */
    }

    #kanbanBoardView::-webkit-scrollbar {
      display: none;
      /* WebKit browsers */
    }

    .column.drop-zone {
      background-color: #374151;
      border: 2px dashed #4b5563;
    }

    .column.drop-zone.drag-over {
      background-color: #4b5563;
      border-color: #60a5fa;
    }
  </style>
</head>

<body class="bg-gray-900 text-gray-200 antialiased">
  <!-- =========== LOGIN VIEW =========== -->
  <div id="loginView" class="min-h-screen flex items-center justify-center bg-gray-900 p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-cyan-400">NexusFlow</h1>
        <p class="text-gray-400 mt-2">The future of project collaboration.</p>
      </div>
      <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-8">
        <form id="loginForm">
          <div class="mb-4">
            <label for="email" class="block text-gray-400 text-sm font-bold mb-2">Email Address</label>
            <input type="email" id="email" placeholder="Enter your email"
              class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500 transition-colors"
              required />
          </div>
          <div class="mb-6">
            <label for="password" class="block text-gray-400 text-sm font-bold mb-2">Password</label>
            <input type="password" id="password" placeholder="Enter your password"
              class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500 transition-colors"
              required />
          </div>
          <button type="submit"
            class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg">Sign
            In</button>
          <p class="text-center text-gray-500 text-sm mt-6">
            Don't have an account?
            <a href="#" id="goToRegister" class="text-cyan-400 hover:underline">Sign Up</a>
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- =========== REGISTER VIEW =========== -->
  <div id="registerView" class="min-h-screen hidden items-center justify-center bg-gray-900 p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-cyan-400">NexusFlow</h1>
        <p class="text-gray-400 mt-2">Create your account</p>
      </div>
      <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-8">
        <form id="registerForm">
          <div class="mb-4">
            <label for="reg_name" class="block text-gray-400 text-sm font-bold mb-2">Full Name</label>
            <input type="text" id="reg_name" placeholder="Jane Doe"
              class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500 transition-colors"
              required />
          </div>
          <div class="mb-4">
            <label for="reg_email" class="block text-gray-400 text-sm font-bold mb-2">Email Address</label>
            <input type="email" id="reg_email" placeholder="you@example.com"
              class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500 transition-colors"
              required />
          </div>
          <div class="mb-6">
            <label for="reg_password" class="block text-gray-400 text-sm font-bold mb-2">Password</label>
            <input type="password" id="reg_password" placeholder="Minimum 8 characters" minlength="6"
              class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500 transition-colors"
              required />
          </div>
          <button type="submit"
            class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg">Create
            Account</button>
          <p class="text-center text-gray-500 text-sm mt-6">
            Already have an account?
            <a href="#" id="goToLogin" class="text-cyan-400 hover:underline">Sign In</a>
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- =========== MAIN APPLICATION VIEW =========== -->
  <div id="appView" class="hidden">
    <div class="flex h-screen bg-gray-900">
      <!-- Sidebar -->
      <nav class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
        <div class="p-6 text-center border-b border-gray-700">
          <h1 class="text-2xl font-bold text-cyan-400">NexusFlow</h1>
        </div>
        <div class="flex-grow p-4 space-y-2 overflow-y-auto">
          <h3 class="px-4 text-sm font-semibold text-gray-500 uppercase tracking-wider">Projects</h3>
          <ul id="projectNav" class="space-y-1"></ul>
          <button id="addNewProjectBtn"
            class="w-full mt-2 text-sm text-gray-400 hover:bg-gray-700 p-2 rounded-lg flex items-center gap-2">
            <span class="material-icons-outlined">add</span>New Project
          </button>
          <hr class="border-gray-700 my-4" />
          <h3 class="px-4 text-sm font-semibold text-gray-500 uppercase tracking-wider">Tools</h3>
          <ul id="mainNav" class="space-y-1">
            <li><a href="#" data-view="todoView"
                class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-gray-200"><span
                  class="material-icons-outlined">check_box</span>To-Do Lists</a></li>
            <li><a href="#" data-view="taskTrackingView"
                class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-gray-200"><span
                  class="material-icons-outlined">grid_on</span>Task Tracking</a></li>
            <li><a href="#" data-view="milestonesView"
                class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-gray-200"><span
                  class="material-icons-outlined">flag</span>Milestones</a></li>
            <li><a href="#" data-view="communicationView" id="commNavLink"
                class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-gray-200"><span
                  class="material-icons-outlined">send</span>Communication</a></li>
            <li><a href="#" data-view="profileView"
                class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-gray-200"><span
                  class="material-icons-outlined">person</span>Profiles</a></li>
          </ul>
        </div>
        <div class="p-4 border-t border-gray-700">
          <button id="logoutBtn"
            class="w-full flex items-center justify-center gap-3 px-4 py-2 rounded-lg text-gray-400 hover:bg-red-800/50 hover:text-red-300">
            <span class="material-icons-outlined">logout</span>Logout
          </button>
        </div>
      </nav>

      <!-- Main -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <header
          class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-4 flex justify-between items-center flex-shrink-0">
          <h2 id="viewTitle" class="text-xl font-semibold"></h2>
          <div class="flex items-center gap-4">
            <img src="https://placehold.co/40x40/1f2937/9ca3af?text=PM" alt="User Avatar" class="rounded-full" />
            <div id="currentUserDisplay"></div>
          </div>
        </header>
        <div class="flex-1 overflow-y-auto" id="mainContent"></div>
      </main>
    </div>
  </div>

  <!-- =========== MODALS (containers only; content is rendered by JS) =========== -->
  <div id="modalsContainer"></div>

  <!-- Color picker for grid (unchanged) -->
  <div id="colorPickerModal" class="hidden absolute bg-gray-700 rounded-lg shadow-xl p-2 z-50">
    <div class="grid grid-cols-4 gap-1">
      <div class="w-6 h-6 rounded bg-green-500 cursor-pointer" data-color="bg-green-500"></div>
      <div class="w-6 h-6 rounded bg-yellow-500 cursor-pointer" data-color="bg-yellow-500"></div>
      <div class="w-6 h-6 rounded bg-red-500 cursor-pointer" data-color="bg-red-500"></div>
      <div class="w-6 h-6 rounded bg-blue-500 cursor-pointer" data-color="bg-blue-500"></div>
      <div class="w-6 h-6 rounded bg-indigo-500 cursor-pointer" data-color="bg-indigo-500"></div>
      <div class="w-6 h-6 rounded bg-purple-500 cursor-pointer" data-color="bg-purple-500"></div>
      <div class="w-6 h-6 rounded bg-pink-500 cursor-pointer" data-color="bg-pink-500"></div>
      <div class="w-6 h-6 rounded bg-gray-800 border border-gray-600 cursor-pointer" data-color=""></div>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf || {};

    // ====================== API HELPERS (Same-origin) ======================
    const API_BASE = "";
    const LS_TOKEN_KEY = "nf_token";
    const LS_USER_KEY = "nf_user";
    const LS_CURRENT_VIEW_KEY = "nf_current_view";

    async function apiFetch(path, { method = "GET", body, headers = {} } = {}) {
      const token = localStorage.getItem(LS_TOKEN_KEY);
      let userIdHeader = {};
      try {
        const u = JSON.parse(localStorage.getItem(LS_USER_KEY) || "null");
        if (u?.email) userIdHeader = { "x-user-id": u.email };
      } catch (_) { }

      const res = await fetch(`${API_BASE}${path}`, {
        method,
        headers: {
          "Content-Type": "application/json",
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
          ...userIdHeader,
          ...headers,
        },
        body: body ? JSON.stringify(body) : undefined,
        credentials: "same-origin",
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw { status: res.status, data };
      return data;
    }

    async function apiUpload(path, formData) {
      const token = localStorage.getItem(LS_TOKEN_KEY);
      const headers = (() => {
        let h = {};
        if (token) h.Authorization = `Bearer ${token}`;
        try {
          const u = JSON.parse(localStorage.getItem(LS_USER_KEY) || "null");
          if (u?.email) h["x-user-id"] = u.email;
        } catch (_) { }
        return h;
      })();

      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers,
        body: formData,
        credentials: "same-origin",
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw { status: res.status, data };
      return data;
    }

    function saveAuth({ token, user }) {
      localStorage.setItem(LS_TOKEN_KEY, token ?? "");
      localStorage.setItem(LS_USER_KEY, JSON.stringify(user ?? {}));
    }
    function loadAuth() {
      const token = localStorage.getItem(LS_TOKEN_KEY);
      const user = JSON.parse(localStorage.getItem(LS_USER_KEY) || "null");
      return token && user ? { token, user } : null;
    }
    function clearAuth() {
      localStorage.removeItem(LS_TOKEN_KEY);
      localStorage.removeItem(LS_USER_KEY);
      localStorage.removeItem(LS_CURRENT_VIEW_KEY);
    }
    
    function saveCurrentView(view) {
      localStorage.setItem(LS_CURRENT_VIEW_KEY, view);
    }
    
    function loadCurrentView() {
      return localStorage.getItem(LS_CURRENT_VIEW_KEY) || "dashboardView";
    }

    // ==== Task & Priority mappers (UI <-> API) ====
    const UI_COLS = ["Backlog", "Pending", "Assigned", "In Progress", "Waiting to Review", "Finished"];
    const uiToApiStatus = {
      Backlog: "todo",
      Pending: "pending",       // Use distinct status for Pending
      Assigned: "assigned",     // Use distinct status for Assigned
      "In Progress": "in_progress",
      "Waiting to Review": "review",
      Finished: "done",
    };
    const apiToUiStatus = {
      "todo": "Backlog",
      "pending": "Pending",
      "assigned": "Assigned",
      "in_progress": "In Progress",
      "review": "Waiting to Review",
      "done": "Finished"
    };
    const uiToApiPriority = { Low: "low", Medium: "medium", High: "high", Urgent: "urgent" };
    const apiToUiPriority = { low: "Low", medium: "Medium", high: "High", urgent: "Urgent" };
    function columnTitleToIndex(title) { return UI_COLS.indexOf(title); }

    // ====================== APP ======================
    document.addEventListener("DOMContentLoaded", () => {
      // DOM
      const loginView = document.getElementById("loginView");
      const registerView = document.getElementById("registerView");
      const appView = document.getElementById("appView");
      const modalsContainer = document.getElementById("modalsContainer");
      const viewTitle = document.getElementById("viewTitle");
      const goToRegister = document.getElementById("goToRegister");
      const goToLogin = document.getElementById("goToLogin");

      // Simple view routing
      function showLogin() {
        loginView.classList.remove("hidden"); loginView.classList.add("flex");
        registerView.classList.add("hidden"); registerView.classList.remove("flex");
        appView.classList.add("hidden"); history.replaceState(null, "", "#/login");
      }
      function showRegister() {
        loginView.classList.add("hidden"); loginView.classList.remove("flex");
        registerView.classList.remove("hidden"); registerView.classList.add("flex");
        appView.classList.add("hidden"); history.replaceState(null, "", "#/register");
      }
      function showApp() {
        loginView.classList.add("hidden"); registerView.classList.add("hidden");
        appView.classList.remove("hidden"); history.replaceState(null, "", "#/app");
      }

      if (location.hash === "#/register") showRegister(); else showLogin();
      if (goToRegister) goToRegister.addEventListener("click", (e) => { e.preventDefault(); showRegister(); });
      if (goToLogin) goToLogin.addEventListener("click", (e) => { e.preventDefault(); showLogin(); });

      // ---------- State ----------
      let state = {
        currentUser: null,
        currentView: loadCurrentView(),
        dashboardMode: "board",
        profileViewMode: "grid",
        calendarDate: new Date(),
        activeProjectId: null,
        activeTodoListId: null,
        activeMilestoneProjectId: null,
        activeTask: null,
        activeTodoItem: null,
        activeProfile: null,

        isTaskModalOpen: false,
        isTodoModalOpen: false,
        isInfoModalOpen: false,
        isMoveToProjectModalOpen: false,
        isMoveTaskModalOpen: false,
        isMilestoneModalOpen: false,
        isProfileModalOpen: false,
        isAiModalOpen: false,
        isProjectModalOpen: false,
        isShareModalOpen: false,

        infoModalContent: { title: "", body: "" },
        activeMilestone: null, // holds milestone object when editing
        itemToMove: null,
        taskToMove: null,
        selectedTasksForAI: new Set(),
        taskToShare: null,

        gridData: [
          ["Task Name", "Assignee", "Mon", "Tue", "Wed", "Thu", "Fri", "Status"],
          [
            { text: "API Endpoint Design", color: "" },
            { text: "John S.", color: "" },
            { text: "", color: "bg-green-500" },
            { text: "", color: "bg-green-500" },
            { text: "", color: "bg-yellow-500" },
            { text: "", color: "" },
            { text: "", color: "" },
            { text: "In Progress", color: "" },
          ],
          [
            { text: "Frontend UI Mockup", color: "" },
            { text: "Jane D.", color: "" },
            { text: "", color: "" },
            { text: "", color: "" },
            { text: "", color: "" },
            { text: "", color: "" },
            { text: "", color: "" },
            { text: "Pending", color: "" },
          ],
        ],

        projects: [],
        todoLists: [],

        users: [
          {
            id: 1,
            name: "John Smith",
            title: "Backend Engineer",
            description: "Specializes in Node.js and database architecture.",
            email: "john.s@example.com",
            phone: "123-456-7890",
            linkedin: "https://linkedin.com/in/johnsmith",
            github: "https://github.com/johnsmith",
            languages: ["JavaScript", "SQL", "Python"],
            adminFeedback: "Consistently delivers high-quality, scalable code.",
            avatar: "...",
            resumeUrl: null,
          },
        ],
        communicationLogs: [
          {
            id: 1,
            timestamp: "2025-09-15 10:30 AM",
            recipient: "John Smith",
            summary: "Update on task #103",
            message: "Hey John, just wanted to check on the progress for the API authentication endpoint. Let me know if you need any help.",
          },
        ],
      };

      const priorityStyles = {
        Low: "bg-green-500/20 text-green-300",
        Medium: "bg-yellow-500/20 text-yellow-300",
        High: "bg-red-500/20 text-red-300",
        Urgent: "bg-red-500/20 text-red-300",
      };

      const defaultColumns = () => [
        { id: Date.now(), title: "Backlog", tasks: [] },
        { id: Date.now() + 1, title: "Pending", tasks: [] },
        { id: Date.now() + 2, title: "Assigned", tasks: [] },
        { id: Date.now() + 3, title: "In Progress", tasks: [] },
        { id: Date.now() + 4, title: "Waiting to Review", tasks: [] },
        { id: Date.now() + 5, title: "Finished", tasks: [] },
      ];

      function findTaskById(taskId) {
        for (const p of state.projects) {
          for (const c of p.columns) {
            const t = c.tasks.find((t) => t.id === taskId);
            if (t) return t;
          }
        }
        return null;
      }

      // Build Task Tracking Matrix (Task Name, Assignee, Mon..Fri, Status) from the active project's tasks
      function syncTaskTrackingFromProject(project) {
        const header = ["Task Name", "Assignee", "Mon", "Tue", "Wed", "Thu", "Fri", "Status"];
        const rows = [];

        project.columns.forEach((col) => {
          (col.tasks || []).forEach((t) => {
            // Get the actual assignee name - use assigneeId to look up in state.users
            let assigneeName = t.assignee || "";

            // If we have an assigneeId but no assignee name, try to look it up
            // assigneeId is a user_id (from task.assignee_id), so match on userId
            if (t.assigneeId && !assigneeName) {
              const user = state.users.find(u => u.userId && Number(u.userId) === Number(t.assigneeId));
              if (user) {
                assigneeName = user.name;
              } else if (state.assigneeNameByUserId?.[t.assigneeId]) {
                assigneeName = state.assigneeNameByUserId[t.assigneeId];
              }
            }

            // Get communication days from aiComm
            const commDays = (t.aiComm?.days || []);
            const dayMap = {
              "Mon": commDays.includes("Mon") ? "✓" : "",
              "Tue": commDays.includes("Tue") ? "✓" : "",
              "Wed": commDays.includes("Wed") ? "✓" : "",
              "Thu": commDays.includes("Thu") ? "✓" : "",
              "Fri": commDays.includes("Fri") ? "✓" : ""
            };

            rows.push([
              { text: t.content || t.title || "", color: "" },
              { text: assigneeName, color: "" }, // Use the properly resolved assignee name
              { text: dayMap["Mon"], color: "" },
              { text: dayMap["Tue"], color: "" },
              { text: dayMap["Wed"], color: "" },
              { text: dayMap["Thu"], color: "" },
              { text: dayMap["Fri"], color: "" },
              { text: col.title, color: "" },
            ]);
          });
        });

        state.gridData = [header, ...rows];
        if (state.currentView === "taskTrackingView") {
          renderCsvAsGrid(state.gridData);
          setupExportButtons();
        }
      }

      // ===== Hydrate Projects from API, then their Tasks =====
      async function hydrateProjects() {
        try {
          const projects = await apiFetch("/api/projects");
          state.projects = (projects || []).map((row) => ({
            id: row.id,
            name: row.name,
            description: row.description ?? "",
            columns: defaultColumns(),
            milestones: [], // will be fetched per project
            _tasksLoaded: false,
            _milestonesLoaded: false,
          }));
          if (state.projects.length && !state.activeProjectId) {
            state.activeProjectId = state.projects[0].id;
          }
        } catch (err) {
          console.warn("Failed to load projects, showing local sample:", err);
          if (!state.projects.length) {
            state.projects = [
              { id: 1, name: "Sample Project", columns: defaultColumns(), milestones: [], _tasksLoaded: true, _milestonesLoaded: true },
            ];
            state.activeProjectId = 1;
          }
        }
        if (state.activeProjectId) await hydrateTasksForProject(state.activeProjectId);
        else render();
      }

      // ===== To-Do Lists: load from backend =====
      async function hydrateTodoLists() {
        try {
          const lists = await apiFetch("/api/todos/lists");
          state.todoLists = (lists || []).map((l) => ({ id: l.id, name: l.name, items: [] }));
          if (state.todoLists.length) {
            state.activeTodoListId = state.todoLists[0].id;
            await loadTodoItems(state.activeTodoListId);
          } else {
            render();
          }
        } catch (err) {
          console.warn("Failed to load todo lists:", err);
          render();
        }
      }

      async function loadTodoItems(listId) {
        try {
          const rows = await apiFetch(`/api/todos/lists/${listId}/items`);
          const mapped = rows.map((i) => ({
            id: i.id,
            content: i.content,
            description: i.description || "",
            links: i.link || "",
            priority: i.priority || "Medium",
            dueDate: i.dueDate || "",
            assignee: i.assigneeId || null,
            thingsToConsider: i.considerations || "",
            subtasks: (i.tags || []).map((t) => ({ text: t, done: false })),
            createdAt: Date.parse(i.createdAt || "") || Date.now(),
          }));
          const list = state.todoLists.find((l) => l.id === listId);
          if (list) list.items = mapped;
          render();
        } catch (err) {
          console.warn("Failed to load list items:", err);
        }
      }

      // ===== Hydrate Profiles from API =====
      async function hydrateProfiles() {
        try {
          const rows = await apiFetch("/api/profiles?q=&page=1&limit=100");
          state.users = rows.map((r) => ({
            id: r.id, // profile ID
            userId: r.user_id, // user ID (for matching with task assignee_id)
            name: r.full_name,
            title: r.title || "",
            description: r.description || "",
            email: r.email || "",
            phone: r.phone || "",
            linkedin: r.linkedin_url || "",
            github: r.github_url || "",
            languages: Array.isArray(r.languages) ? r.languages : [],
            adminFeedback: r.admin_feedback || "",
            avatar: "...",
            resumeUrl: r.resume_url || null,
          }));

          // Build a quick lookup: user_id -> display name (for task assignee_id matching)
          state.assigneeNameByUserId = {};
          (state.users || []).forEach((u) => {
            if (u.userId) {
              state.assigneeNameByUserId[u.userId] = u.name;
            }
            // Also keep profile ID lookup for backward compatibility
            state.assigneeNameById = state.assigneeNameById || {};
            state.assigneeNameById[u.id] = u.name;
          });

          // If tasks are already loaded, refresh names on cards & the matrix
          if (state.activeProjectId) {
            const p = state.projects.find((x) => x.id === state.activeProjectId);
            if (p && p._tasksLoaded) {
              // make sure each task has a display name
              // assigneeId is a user_id, so use assigneeNameByUserId lookup
              let updated = false;
              p.columns.forEach((c) =>
                (c.tasks || []).forEach((t) => {
                  if (t.assigneeId != null) {
                    const newName = state.assigneeNameByUserId?.[t.assigneeId] || "";
                    if (newName && t.assignee !== newName) {
                      t.assignee = newName;
                      updated = true;
                    }
                  }
                })
              );
              // rebuild Task Tracking Matrix and re-render if we updated anything
              if (updated && typeof syncTaskTrackingFromProject === "function") {
                syncTaskTrackingFromProject(p);
              }
              if (updated) {
                render();
                return; // we've already re-rendered
              }
            }
          }
          
          // Also try to load users directly as fallback for assignee lookup
          try {
            const users = await apiFetch("/api/users");
            if (users && Array.isArray(users)) {
              // Build additional lookup map from users table
              users.forEach((u) => {
                if (u.id && u.name && !state.assigneeNameByUserId?.[u.id]) {
                  state.assigneeNameByUserId = state.assigneeNameByUserId || {};
                  state.assigneeNameByUserId[u.id] = u.name;
                }
              });
              
              // Refresh tasks again with user data
              if (state.activeProjectId) {
                const p = state.projects.find((x) => x.id === state.activeProjectId);
                if (p && p._tasksLoaded) {
                  let updated = false;
                  p.columns.forEach((c) =>
                    (c.tasks || []).forEach((t) => {
                      if (t.assigneeId != null && !t.assignee) {
                        const newName = state.assigneeNameByUserId?.[t.assigneeId] || "";
                        if (newName) {
                          t.assignee = newName;
                          updated = true;
                        }
                      }
                    })
                  );
                  if (updated && typeof syncTaskTrackingFromProject === "function") {
                    syncTaskTrackingFromProject(p);
                    render();
                  }
                }
              }
            }
          } catch (err) {
            // Silently fail - users endpoint might not be available
          }
          // END ADD

          if (state.currentView === "profileView") render();
        } catch (err) {
          console.warn("Failed to load profiles:", err);
        }
      }

      // ===== Hydrate Tasks for one Project =====
      async function hydrateTasksForProject(projectId) {
        const project = state.projects.find((p) => p.id === projectId);
        if (!project) return;

        // reset columns
        project.columns.forEach((c) => (c.tasks = []));

        try {
          const tasks = await apiFetch(`/api/tasks?projectId=${projectId}&limit=200`);
          // Pull communication schedules for these tasks
          let schedulesByTask = {};
          try {
            const comm = await apiFetch(`/api/communications?projectId=${projectId}`);
            schedulesByTask = Object.fromEntries((comm?.schedules || []).map((s) => [s.task_id, s]));
          } catch { }

          (tasks || []).forEach((t) => {
            // Find the user by assignee_id (which is a user_id, not profile id)
            let assigneeName = "";
            if (t.assignee_id) {
              // Try multiple lookup methods:
              // 1. Look up by user_id in profiles
              const user = state.users.find(u => u.userId && Number(u.userId) === Number(t.assignee_id));
              if (user) {
                assigneeName = user.name;
              } else {
                // 2. Try lookup map
                assigneeName = state.assigneeNameByUserId?.[t.assignee_id] || "";
                // 3. If still not found, try direct user lookup (fallback)
                if (!assigneeName) {
                  const directUser = state.users.find(u => Number(u.id) === Number(t.assignee_id));
                  if (directUser) assigneeName = directUser.name;
                }
              }
            }

            const sched = schedulesByTask[t.id];
            const uiTask = {
              id: t.id,
              content: t.title,
              notes: t.description || "",
              assigneeId: t.assignee_id ?? null,
              assignee: assigneeName, // Set the actual name here
              links: "",
              dueDate: t.due_date || t.dueDate || "",
              priority: apiToUiPriority[t.priority] || "Medium",
              aiComm: { active: !!sched?.active, frequency: sched?.frequency || "daily", days: sched?.days || [], prompt: sched?.prompt || "" },
              subtasks: [],
            };

            const colTitle = apiToUiStatus[t.status] || "Backlog";
            const colIdx = columnTitleToIndex(colTitle);
            if (colIdx >= 0) project.columns[colIdx].tasks.push(uiTask);
            else project.columns[0].tasks.push(uiTask);
          });

          project._tasksLoaded = true;

          // keep Task Tracking Matrix in sync with the board
          syncTaskTrackingFromProject(project);

          render();
        } catch (e) {
          console.warn("Failed to load tasks:", e);
        }
      }

      // ===== Milestones API integration =====
      async function loadMilestones(projectId) {
        const project = state.projects.find(p => p.id === projectId);
        if (!project) return;
        try {
          const rows = await apiFetch(`/api/milestones?projectId=${projectId}`);
          project.milestones = (rows || []).map(r => ({
            id: r.id,
            projectId: r.project_id,
            title: r.title,
            description: r.description || "",
            dueDate: r.due_date || "",
            priority: r.priority || "Medium",
            difficulty: r.difficulty || "Medium",
            createdAt: r.created_at,
          }));
          project._milestonesLoaded = true;
          render();
        } catch (err) {
          console.warn("Failed to load milestones:", err);
          project.milestones = project.milestones || [];
          project._milestonesLoaded = true;
          render();
        }
      }

      async function createMilestone(projectId, data) {
        const payload = {
          projectId,
          title: data.title,
          description: data.description || null,
          dueDate: data.dueDate || null,
          priority: data.priority || "Medium",
          difficulty: data.difficulty || "Medium",
        };
        const row = await apiFetch(`/api/milestones`, { method: "POST", body: payload });
        return {
          id: row.id,
          projectId: row.project_id,
          title: row.title,
          description: row.description || "",
          dueDate: row.due_date || "",
          priority: row.priority || "Medium",
          difficulty: row.difficulty || "Medium",
          createdAt: row.created_at,
        };
      }

      async function updateMilestone(milestoneId, data) {
        const patch = {};
        if (data.title !== undefined) patch.title = data.title;
        if (data.description !== undefined) patch.description = data.description ?? null;
        if (data.dueDate !== undefined) patch.dueDate = data.dueDate || null;
        if (data.priority !== undefined) patch.priority = data.priority;
        if (data.difficulty !== undefined) patch.difficulty = data.difficulty;
        const row = await apiFetch(`/api/milestones/${milestoneId}`, { method: "PATCH", body: patch });
        return {
          id: row.id,
          projectId: row.project_id,
          title: row.title,
          description: row.description || "",
          dueDate: row.due_date || "",
          priority: row.priority || "Medium",
          difficulty: row.difficulty || "Medium",
          createdAt: row.created_at,
        };
      }

      async function deleteMilestone(milestoneId) {
        await apiFetch(`/api/milestones/${milestoneId}`, { method: "DELETE" });
      }

      // ---------- Communication Nav Visibility Function ----------
      function updateCommunicationNavVisibility() {
        const comm = document.getElementById("commNavLink");
        if (comm && state.currentUser) {
          // Show Communication for all authenticated users
          comm.style.display = 'flex';
        }
      }

      // ---------- AUTH: LOGIN (API) ----------
      const loginForm = document.getElementById("loginForm");
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value.trim().toLowerCase();
        const password = document.getElementById("password").value;
        try {
          const { token, user } = await apiFetch("/api/auth/login", { method: "POST", body: { email, password } });
          saveAuth({ token, user });
          state.currentUser = { email: user.email, name: user.name, role: user.role || "member" };
          document.getElementById("currentUserDisplay").innerHTML =
            `<p class="font-semibold text-sm">${state.currentUser.name}</p>
             <p class="text-xs text-gray-400">${state.currentUser.email} (${state.currentUser.role})</p>`;

          // FIX: Update communication nav visibility
          setTimeout(() => {
            updateCommunicationNavVisibility();
          }, 100);

          showApp();
          await hydrateProjects();
          await hydrateProfiles();
          await hydrateTodoLists();
        } catch (err) {
          alert(err?.data?.error || "Invalid email or password.");
        }
      });

      // ---------- AUTH: REGISTER (API) ----------
      const registerForm = document.getElementById("registerForm");
      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("reg_name").value.trim();
        const email = document.getElementById("reg_email").value.trim().toLowerCase();
        const password = document.getElementById("reg_password").value;
        try {
          await apiFetch("/api/users", { method: "POST", body: { name, email, password } });
          const { token, user } = await apiFetch("/api/auth/login", { method: "POST", body: { email, password } });
          saveAuth({ token, user });
          state.currentUser = { email: user.email, name: user.name, role: user.role || "member" };
          document.getElementById("currentUserDisplay").innerHTML =
            `<p class="font-semibold text-sm">${state.currentUser.name}</p>
             <p class="text-xs text-gray-400">${state.currentUser.email} (${state.currentUser.role})</p>`;

          // FIX: Update communication nav visibility
          setTimeout(() => {
            updateCommunicationNavVisibility();
          }, 100);

          showApp();
          await hydrateProjects();
          await hydrateProfiles();
          await hydrateTodoLists();
        } catch (err) {
          const msg =
            err?.data?.error?.formErrors?.join?.(", ") ||
            (err?.data?.error?.fieldErrors && Object.values(err.data.error.fieldErrors).flat().join(", ")) ||
            err?.data?.error ||
            "Registration failed";
          alert(msg);
        }
      });

      // ---------- Restore session ----------
      const saved = loadAuth();
      if (saved?.user) {
        state.currentUser = { email: saved.user.email, name: saved.user.name, role: saved.user.role || "member" };
        document.getElementById("currentUserDisplay").innerHTML =
          `<p class="font-semibold text-sm">${state.currentUser.name}</p>
           <p class="text-xs text-gray-400">${state.currentUser.email} (${state.currentUser.role})</p>`;

        // FIX: Update communication nav visibility
        setTimeout(() => {
          updateCommunicationNavVisibility();
        }, 100);

        showApp();
        Promise.all([hydrateProjects(), hydrateProfiles(), hydrateTodoLists()]).catch(console.warn);
      }

      // ---------- Logout ----------
      const logoutBtn = document.getElementById("logoutBtn");
      logoutBtn.addEventListener("click", () => {
        clearAuth();
        state.currentUser = null;
        showLogin();
      });

      // ---------- Renderers ----------
      function render() {
        if (!state.currentUser) return;
        renderProjectsNav();
        renderMainNavLinkStates();
        renderMainContent();
        renderModals();
        // If AI modal is open, populate its containers asynchronously
        if (state.isAiModalOpen) {
          setTimeout(async () => {
            for (const taskId of Array.from(state.selectedTasksForAI)) {
              const task = findTaskById(taskId);
              const cont = document.getElementById(`ai-cont-${taskId}`);
              if (!task || !cont) continue;
              try {
                const res = await fetch('/api/ai/suggest-assignees', {
                  method: 'POST', headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ title: task.content, description: task.notes || '', topK: 2 })
                });
                const json = await res.json();
                const suggestions = json?.suggestions || [];
                const usersById = Object.fromEntries((state.users || []).map(u => [String(u.id), u]));
                cont.innerHTML = suggestions.map((s, i) => {
                  const u = usersById[String(s.profileId)];
                  const name = u?.name || `#${s.profileId}`;
                  const sub = [u?.title, Array.isArray(u?.languages) && u.languages.length ? u.languages.join(', ') : ''].filter(Boolean).join(' • ');
                  const pct = Math.round((s.score ?? 0) * 100);
                  return `<div class=\"bg-gray-800 p-3 rounded-lg ${i === 0 ? 'border-2 border-green-500' : 'border border-gray-600'} cursor-pointer hover:bg-gray-700\" data-profile-id=\"${s.profileId}\" data-task-id=\"${taskId}\" data-score=\"${s.score}\" onclick=\"selectAiSuggestion(this)\">
                    <p class=\"font-semibold\">${i === 0 ? 'Top Recommendation' : 'Second Choice'}: ${name}</p>
                    ${sub ? `<div class=\"text-xs text-gray-400 mt-1\">${sub}</div>` : ''}
                    ${s.reason ? `<div class=\"text-xs text-gray-500 mt-1\">Reason: ${s.reason}</div>` : ''}
                    <div class=\"text-xs text-gray-300 mt-1\">Score: ${pct}%</div>
                  </div>`;
                }).join('') || '<div class=\"text-gray-400\">No profiles found</div>';
              } catch {
                cont.textContent = 'Failed to load suggestions';
              }
            }
          }, 0);
        }
        // If on communication view, fetch logs and refresh table
        if (state.currentView === 'communicationView') {
          (async () => {
            try {
              const { logs } = await apiFetch('/api/communications');
              state.communicationLogs = (logs || []).map(l => ({
                timestamp: new Date(l.timestamp).toLocaleString(),
                recipient: l.recipient || '-',
                summary: l.summary || '',
              }));
              const main = document.getElementById('mainContent');
              if (main) main.innerHTML = renderCommunicationView();
            } catch { }
          })();
        }
        updateCommunicationNavVisibility(); // Add this line
      }

      // Handle clicking on AI suggestions in both modals
      window.selectAiSuggestion = function (element) {
        const profileId = element.dataset.profileId;
        const taskId = element.dataset.taskId;

        if (state.isAiModalOpen) {
          // In Analyze & Assign modal - update the task's assignee
          const task = findTaskById(parseInt(taskId));
          if (task) {
            const user = state.users.find(u => u.id == profileId);
            if (user) {
              // Store user_id (not profile id) in assigneeId since backend expects user_id
              task.assigneeId = user.userId ? parseInt(user.userId) : parseInt(profileId);
              task.assignee = user.name;

              // Highlight the selected suggestion
              const container = document.getElementById(`ai-cont-${taskId}`);
              if (container) {
                // Remove previous highlights
                container.querySelectorAll('.selected-suggestion').forEach(el => {
                  el.classList.remove('selected-suggestion', 'bg-green-600', 'border-green-400');
                  el.classList.add('bg-gray-800');
                });
                // Highlight current selection
                element.classList.add('selected-suggestion', 'bg-green-600', 'border-green-400');
                element.classList.remove('bg-gray-800');

                // Add checkmark to show it's selected
                element.innerHTML = element.innerHTML.replace(
                  /<div class="text-xs text-gray-300 mt-1">Score: \d+%<\/div>/,
                  '<div class="text-xs text-gray-300 mt-1">Score: ' + Math.round((element.dataset.score || 0) * 100) + '%</div><div class="text-xs text-green-300 mt-1">✓ Selected</div>'
                );
              }

              // Update the task in the database (no immediate render to preserve selection)
              // Send user_id if available, otherwise send profile ID (backend will convert)
              const assigneeIdToSend = user.userId ? parseInt(user.userId) : parseInt(profileId);
              apiFetch(`/api/tasks/${taskId}`, {
                method: 'PATCH',
                body: { assigneeId: assigneeIdToSend }
              }).then(response => {
                // Update local state with the actual user_id from response if available
                if (response.assignee_id) {
                  task.assigneeId = response.assignee_id;
                }
              }).catch(err => {
                console.error('Failed to assign:', err);
              });
            }
          }
        } else {
          // In task modal - update the assignee dropdown
          const assigneeSelect = document.querySelector('select[name="assignee"]');
          if (assigneeSelect) {
            assigneeSelect.value = profileId;
            // Close the suggestions panel
            const suggestionsEl = document.getElementById('aiSuggestions');
            if (suggestionsEl) suggestionsEl.classList.add('hidden');
          }
        }
      }
      function renderProjectsNav() {
        const nav = document.getElementById("projectNav");
        nav.innerHTML = state.projects.map((p) => `
          <li>
            <a href="#" data-project-id="${p.id}"
               class="project-link flex justify-between items-center px-4 py-2 rounded-lg ${p.id === state.activeProjectId && state.currentView === "dashboardView" ? "bg-gray-700 text-gray-200" : "text-gray-400 hover:bg-gray-700/50"}">
              <span>${p.name}</span>
            </a>
          </li>`).join("");
      }
      function renderMainNavLinkStates() {
        document.querySelectorAll("#mainNav .nav-link").forEach((l) => {
          l.classList.toggle("bg-gray-700", l.dataset.view === state.currentView);
          l.classList.toggle("text-gray-200", l.dataset.view === state.currentView);
        });
      }
      function renderMainContent() {
        let content = "";
        switch (state.currentView) {
          case "dashboardView": {
            const p = state.projects.find((p) => p.id === state.activeProjectId);
            if (p) { viewTitle.textContent = `${p.name} Dashboard`; content = renderDashboard(p); }
            else { viewTitle.textContent = "Dashboard"; content = `<div class="p-6 text-gray-400">No project selected.</div>`; }
            break;
          }
          case "todoView": viewTitle.textContent = "To-Do Lists"; content = renderTodoView(); break;
          case "taskTrackingView": viewTitle.textContent = "Task Tracking Matrix"; content = renderTaskTrackingView(); break;
          case "communicationView":
            viewTitle.textContent = "Communication";
            content = renderCommunicationView();
            break;
          case "profileView": viewTitle.textContent = "Developer Profiles"; content = renderProfileView(); break;
          case "milestonesView": viewTitle.textContent = "Milestones"; content = renderMilestonesView(); break;
        }
        document.getElementById("mainContent").innerHTML = content;

        if (state.currentView === "dashboardView") {
          const project = state.projects.find((p) => p.id === state.activeProjectId);
          if (!project) return;
          if (state.dashboardMode === "table") renderTableView(project);
          if (state.dashboardMode === "calendar") renderCalendarView(project);
          if (state.dashboardMode === "board") setupDragAndDrop();
        }
        if (state.currentView === "taskTrackingView") {
          renderCsvAsGrid(state.gridData);
          setupExportButtons();
        }
      }

      function renderDashboard(project) {
        return `<div class="p-6 h-full flex flex-col">
          <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center justify-between">
            <div class="flex items-center gap-4">
              <button id="addTaskBtn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-all shadow-md hover:bg-cyan-600"><span class="material-icons-outlined">add</span>Add Task</button>
              <button id="aiAnalyzeBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-all shadow-md hover:bg-indigo-700 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled><span class="material-icons-outlined">psychology</span>Analyze & Assign</button>
            </div>
            <div class="bg-gray-800 p-1 rounded-lg flex items-center">
              <button data-mode="board" class="dashboard-mode-btn px-3 py-1 text-sm rounded-md ${state.dashboardMode === "board" ? "bg-cyan-500 text-white" : "text-gray-400"}">Board</button>
              <button data-mode="table" class="dashboard-mode-btn px-3 py-1 text-sm rounded-md ${state.dashboardMode === "table" ? "bg-cyan-500 text-white" : "text-gray-400"}">Table</button>
              <button data-mode="calendar" class="dashboard-mode-btn px-3 py-1 text-sm rounded-md ${state.dashboardMode === "calendar" ? "bg-cyan-500 text-white" : "text-gray-400"}">Calendar</button>
            </div>
          </div>
          <div id="dashboardContent" class="h-full flex-grow">
            <div id="kanbanBoardView" class="h-full overflow-x-auto pb-4 ${state.dashboardMode === "board" ? "" : "hidden"}">
              <div class="flex gap-6 items-start h-full">${project.columns.map((col) => createColumnHTML(col)).join("")}</div>
            </div>
            <div id="kanbanTableView" class="h-full ${state.dashboardMode === "table" ? "" : "hidden"}"></div>
            <div id="kanbanCalendarView" class="h-full ${state.dashboardMode === "calendar" ? "" : "hidden"}"></div>
          </div>
        </div>`;
      }
      function createColumnHTML(col) {
        const tasks = col.tasks || [];
        return `<div class="bg-gray-800 rounded-xl p-4 w-80 flex-shrink-0 flex flex-col h-full column drop-zone" data-column-id="${col.id}">
          <h3 class="font-bold text-lg text-cyan-300 mb-4">${col.title} (${tasks.length})</h3>
          <div class="tasks-container flex-grow space-y-4 overflow-y-auto overflow-x-hidden">${tasks.map((t) => createTaskCardHTML(t)).join("")}</div>
        </div>`;
      }
      // 1) Put this helper anywhere above your renderers
      function getAssigneeName(task, users = state.users) {
        if (task?.assignee && typeof task.assignee === "string") return task.assignee;
        // Handle when "assignee" accidentally carries the numeric id
        if (task?.assignee != null && typeof task.assignee !== "string") {
          const candidateId = Number(task.assignee);
          if (Number.isFinite(candidateId)) {
            // Try user_id lookup first (for user IDs)
            const uNum = users.find((x) => x.userId && Number(x.userId) === candidateId);
            if (uNum) return uNum.name || "";
            // Fallback to profile ID lookup
            const uNumProfile = users.find((x) => Number(x.id) === candidateId);
            if (uNumProfile) return uNumProfile.name || "";
          }
        }
        if (task?.assigneeId != null) {
          // assigneeId is a user_id, so match on userId
          const u = users.find((x) => x.userId && Number(x.userId) === Number(task.assigneeId));
          if (u) return u.name || "";
          // Fallback to lookup map
          if (state.assigneeNameByUserId?.[task.assigneeId]) {
            return state.assigneeNameByUserId[task.assigneeId];
          }
        }
        return "";
      }

      // Normalize a date input to YYYY-MM-DD if user typed DD-MM-YYYY
      function normalizeDateInput(value) {
        if (!value) return null;
        // If already ISO-like YYYY-MM-DD, keep it
        if (/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
        // Convert DD-MM-YYYY → YYYY-MM-DD
        const m = value.match(/^(\d{2})-(\d{2})-(\d{4})$/);
        if (m) {
          const [, dd, mm, yyyy] = m;
          return `${yyyy}-${mm}-${dd}`;
        }
        return value; // fallback
      }

      // 2) Replace createTaskCardHTML with this version
      function createTaskCardHTML(task) {
        const assigneeName = getAssigneeName(task);

        return `<div class="bg-gray-700 p-4 rounded-lg shadow-md hover:bg-gray-600/70 relative task-card" draggable="true" data-task-id="${task.id}">
    <input type="checkbox" class="task-checkbox absolute top-2 right-2 h-5 w-5 bg-gray-600 border-gray-500 rounded text-indigo-500" data-task-id="${task.id}">
    <div class="cursor-pointer task-content" data-task-id="${task.id}">
      <p class="font-medium pr-8">${task.content}</p>
      <div class="flex items-center justify-between mt-4 text-sm text-gray-400">
        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${priorityStyles[task.priority] || "bg-gray-600 text-gray-300"}">
          ${task.priority || "Medium"}
        </span>
        <div class="flex items-center gap-1">
          ${assigneeName
              ? `<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-600 text-gray-300">${assigneeName}</span>`
              : ""
            }
        </div>
      </div>
    </div>
  </div>`;
      }


      function renderTableView(project) {
        const container = document.getElementById("kanbanTableView");
        if (!container) return;
        let table = `<table class="w-full text-sm text-left"><thead class="text-xs text-gray-400 uppercase bg-gray-700/50"><tr><th class="px-6 py-3">Task</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Priority</th><th class="px-6 py-3">Assignee</th><th class="px-6 py-3">Due Date</th></tr></thead><tbody>`;
        project.columns.forEach((col) => {
          col.tasks.forEach((task) => {
            // const assignee = state.users.find((u) => u.name === task.assignee);
            const assigneeName = getAssigneeName(task);
            table += `<tr class="border-b border-gray-700">
              <td class="px-6 py-4 font-medium">${task.content}</td>
              <td class="px-6 py-4">${col.title}</td>
              <td class="px-6 py-4"><span class="px-2 py-0.5 text-xs font-semibold rounded-full ${priorityStyles[task.priority] || "bg-gray-600 text-gray-300"}">${task.priority || "Medium"}</span></td>
              <td class="px-6 py-4">${assigneeName || "Unassigned"}</td>
              <td class="px-6 py-4">${task.dueDate || "N/A"}</td>
            </tr>`;
          });
        });
        table += `</tbody></table>`;
        container.innerHTML = table;
      }
      function renderCalendarView(project) {
        const container = document.getElementById("kanbanCalendarView");
        if (!container) return;
        const tasks = project.columns.flatMap((c) => c.tasks);
        const date = state.calendarDate, year = date.getFullYear(), month = date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthName = date.toLocaleString("default", { month: "long" });

        let html = `<div class="bg-gray-800 p-4 rounded-xl border border-gray-700 h-full flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <button id="prevMonthBtn">&lt;</button>
            <h3 class="text-xl font-bold">${monthName} ${year}</h3>
            <button id="nextMonthBtn">&gt;</button>
          </div>
          <div class="grid grid-cols-7 gap-px bg-gray-700 flex-grow">
            ${["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(d => `<div class="text-center font-semibold text-xs py-2 bg-gray-800">${d}</div>`).join("")}`;
        for (let i = 0; i < firstDay; i++) html += `<div class="bg-gray-800/50"></div>`;
        for (let day = 1; day <= daysInMonth; day++) {
          const dayTasks = tasks.filter((t) =>
            t.dueDate &&
            new Date(t.dueDate).getFullYear() === year &&
            new Date(t.dueDate).getMonth() === month &&
            new Date(t.dueDate).getDate() === day
          );
          html += `<div class="bg-gray-800 p-2 calendar-day overflow-y-auto">
            <div class="font-semibold text-right text-sm">${day}</div>
            <div class="space-y-1 mt-1">
              ${dayTasks.map((t) => `<div class="text-xs bg-cyan-600 p-1 rounded cursor-pointer task-content" data-task-id="${t.id}">${t.content}</div>`).join("")}
            </div>
          </div>`;
        }
        html += `</div></div>`;
        container.innerHTML = html;
      }

      function renderTodoView() {
        const hasLists = state.todoLists && state.todoLists.length > 0;
        const activeList = state.todoLists.find(l => l.id === state.activeTodoListId);
        return `<div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">To-Do Lists</h2>
          </div>
          <div class="flex gap-6">
            <div class="w-full md:w-1/3 lg:w-1/4">
              <h3 class="font-semibold mb-4">My Lists</h3>
              <ul id="todoListsContainer" class="space-y-2">
                ${(state.todoLists || []).map(l => `
                  <a href="#" data-list-id="${l.id}" class="block p-2 rounded-lg ${l.id === state.activeTodoListId ? 'bg-cyan-500/20 text-cyan-300' : 'hover:bg-gray-700'}">${l.name}</a>
                `).join('') || `<p class="text-gray-500">No lists yet.</p>`}
              </ul>
              <button id="addNewListBtn" class="w-full mt-4 text-sm text-gray-400 hover:bg-gray-700 p-2 rounded-lg">+ New List</button>
            </div>

            <div class="w-full md:w-2/3 lg:w-3/4">
              ${hasLists && activeList ? `
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-bold">${activeList.name}</h3>
                  <button id="addNewTodoItemBtn" class="bg-cyan-500 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center gap-2">
                    <span class="material-icons-outlined">add</span>Add Item to List
                  </button>
                </div>
                <div class="space-y-3">
                  ${activeList.items.length ? activeList.items.map(item => `
                    <div class="bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-700/50" data-item-id="${item.id}">
                      <div class="flex justify-between items-center">
                        <p class="font-medium">${item.content}</p>
                        <div class="flex items-center gap-2">
                          <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${priorityStyles[item.priority] || "bg-gray-600 text-gray-300"}">${item.priority || "Medium"}</span>
                          <button data-item-id="${item.id}" class="move-to-project-btn text-xs bg-cyan-600 hover:bg-cyan-700 p-1 rounded">Move to Project</button>
                        </div>
                      </div>
                      ${item.subtasks && item.subtasks.length > 0 ? `<div class="mt-2 flex flex-wrap gap-1">${item.subtasks.map(st => `<span class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full">${st.text}</span>`).join('')}</div>` : ''}
                    </div>
                  `).join('') : `<div class="text-gray-500">No items in this list yet.</div>`}
                </div>
              ` : `
                <div class="text-gray-500">
                  Create your first list to get started.
                </div>
              `}
            </div>
          </div>
        </div>`;
      }

      function renderTaskTrackingView() {
        return `<div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2"><h2 class="text-2xl font-bold">Task Tracking Matrix</h2><span class="info-btn text-gray-500 cursor-pointer" data-info="taskTracking">info</span></div>
            <div class="flex gap-2">
              <label class="text-sm bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-2 px-3 rounded-lg flex items-center gap-2 cursor-pointer">
                <span class="material-icons-outlined">upload</span>Import CSV<input type="file" id="importMatrixCsvInput" class="hidden" accept=".csv">
              </label>
              <button id="exportMatrixCsvBtn" class="text-sm bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2">
                <span class="material-icons-outlined">download</span>Export CSV
              </button>
              <button id="exportMatrixPdfBtn" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2">
                <span class="material-icons-outlined">picture_as_pdf</span>Export PDF
              </button>
            </div>
          </div>
          <div id="csvGrid" class="bg-gray-800 p-4 rounded-xl border border-gray-700 overflow-auto"></div>
        </div>`;
      }

      function renderCsvAsGrid(data) {
        const container = document.getElementById("csvGrid");
        if (!container) return;
        if (!data || !data.length) {
          container.innerHTML = `<p class="text-gray-500 text-center">Upload a CSV file to begin tracking tasks.</p>`;
          return;
        }
        let table = '<table id="csvGridTable" class="w-full">';
        table += "<thead><tr>" + data[0].map((h) => `<th>${h}</th>`).join("") + "</tr></thead>";
        table += "<tbody>";
        data.slice(1).forEach((row, ri) => {
          table += "<tr>" + row.map((cell, ci) =>
            `<td contenteditable="true" class="${cell.color || ""}" data-row="${ri + 1}" data-col="${ci}">${cell.text}</td>`
          ).join("") + "</tr>";
        });
        table += "</tbody></table>";
        container.innerHTML = table;
      }

      function renderCommunicationView() {
        const activeComms = state.projects
          .flatMap(p => p.columns.flatMap(c => c.tasks))
          .filter(t => t.aiComm && t.aiComm.active);

        // Helper function to get assignee name with proper lookup
        const getAssigneeNameForTask = (task) => {
          // If assignee is already set and is a string, use it
          if (task.assignee && typeof task.assignee === 'string') {
            return task.assignee;
          }
          
          // If we have assigneeId, look it up
          if (task.assigneeId != null) {
            // Try multiple lookup methods:
            // 1. Look up by user_id in profiles
            const user = state.users.find(u => u.userId && Number(u.userId) === Number(task.assigneeId));
            if (user) {
              return user.name;
            }
            // 2. Try lookup map
            if (state.assigneeNameByUserId?.[task.assigneeId]) {
              return state.assigneeNameByUserId[task.assigneeId];
            }
            // 3. Fallback to direct user lookup
            const directUser = state.users.find(u => Number(u.id) === Number(task.assigneeId));
            if (directUser) {
              return directUser.name;
            }
          }
          
          return 'Unassigned';
        };

        return `<div class="p-6">
            <h2 class="text-2xl font-bold mb-6">Active AI Communications</h2>
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-x-auto mb-8">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                  <tr>
                    <th class="px-6 py-3">Task</th>
                    <th class="px-6 py-3">Developer</th>
                    <th class="px-6 py-3">Frequency</th>
                    <th class="px-6 py-3">Days</th>
                    <th class="px-6 py-3">Next Message</th>
                  </tr>
                </thead>
                <tbody>
                  ${activeComms.map(task => {
                    const assigneeName = getAssigneeNameForTask(task);
                    return `
                    <tr class="border-b border-gray-700">
                      <td class="px-6 py-4">${task.content}</td>
                      <td class="px-6 py-4">${assigneeName}</td>
                      <td class="px-6 py-4">${task.aiComm.frequency}</td>
                      <td class="px-6 py-4">${(task.aiComm.days || []).join(', ')}</td>
                      <td class="px-6 py-4">Tomorrow 9:00 AM</td>
                    </tr>
                  `;
                  }).join('') || '<tr><td colspan="5" class="text-center p-4 text-gray-500">No active communications.</td></tr>'}
                </tbody>
              </table>
            </div>
            <h2 class="text-2xl font-bold mb-6">Recent Message Logs</h2>
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                  <tr>
                    <th class="px-6 py-3">Timestamp</th>
                    <th class="px-6 py-3">Recipient</th>
                    <th class="px-6 py-3">Summary</th>
                  </tr>
                </thead>
                <tbody>
                  ${(state.communicationLogs || []).map(log => `
                    <tr class="border-b border-gray-700">
                      <td class="px-6 py-4">${log.timestamp}</td>
                      <td class="px-6 py-4">${log.recipient}</td>
                      <td class="px-6 py-4">${log.summary}</td>
                    </tr>
                  `).join('') || '<tr><td colspan="3" class="text-center p-4 text-gray-500">No messages logged yet.</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>`;
      }

      // ---------- Profile View ----------
      function renderProfileView() {
        let content = `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Developer Profiles</h2><button id="addNewProfileBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><span class="material-icons-outlined">add</span>Add New Profile</button></div>`;
        if (state.activeProfile) {
          const p = state.activeProfile;
          content = `<button id="backToProfilesBtn" class="text-gray-400 hover:text-white mb-4">&larr; Back to List</button>
            <div class="bg-gray-800 p-8 rounded-xl border border-gray-700">
              <h2 class="text-2xl font-bold">${p.name}</h2><p class="text-cyan-400">${p.title}</p>
              <div class="mt-4"><strong class="text-gray-400">Description:</strong><p>${p.description || "-"}</p></div>
              <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                <p><strong class="text-gray-400">Email:</strong> ${p.email || "-"}</p>
                <p><strong class="text-gray-400">Phone:</strong> ${p.phone || "-"}</p>
                <p><strong class="text-gray-400">LinkedIn:</strong> ${p.linkedin ? `<a href="${p.linkedin}" class="text-cyan-400 hover:underline" target="_blank">${p.linkedin}</a>` : "-"}</p>
                <p><strong class="text-gray-400">GitHub:</strong> ${p.github ? `<a href="${p.github}" class="text-cyan-400 hover:underline" target="_blank">${p.github}</a>` : "-"}</p>
              </div>
              <div class="mt-4"><strong class="text-gray-400">Coding Languages:</strong>
                <div class="flex flex-wrap gap-2 mt-1">${(p.languages || []).map((l) => `<span class="bg-gray-700 text-cyan-300 text-xs font-medium px-2 py-1 rounded-full">${l}</span>`).join("")}</div>
              </div>
              <div class="mt-4"><strong class="text-gray-400">Admin Feedback:</strong><p class="bg-gray-900/50 p-2 rounded-lg">${p.adminFeedback || "-"}</p></div>
              <div class="mt-4">
                ${p.resumeUrl
              ? `<button class="text-sm bg-gray-700 p-2 rounded-lg view-resume-btn" data-resume="${p.resumeUrl}">View Resume</button>`
              : `<span class="text-sm text-gray-500">No resume uploaded</span>`}
              </div>
            </div>`;
        } else {
          content += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${state.users.map((u) => createProfileCardHTML(u)).join("")}</div>`;
        }
        return `<div class="p-6 max-w-5xl mx-auto">${content}</div>`;
      }
      function createProfileCardHTML(user) {
        return `<div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
          <h3 class="font-bold text-lg">${user.name}</h3>
          <p class="text-sm text-cyan-400">${user.title || ""}</p>
          <div class="mt-2 flex flex-wrap gap-1">${(user.languages || []).slice(0, 3).map((l) => `<span class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full">${l}</span>`).join("")}</div>
          <div class="flex gap-2 mt-4">
            ${user.resumeUrl ? `<button class="view-resume-btn text-xs bg-gray-700 px-2 py-1 rounded" data-resume="${user.resumeUrl}">Resume</button>` : ""}
            <button data-user-id="${user.id}" class="view-profile-btn text-sm text-cyan-400 hover:underline">View Details</button>
          </div>
        </div>`;
      }

      // ---------- Milestones View ----------
      function renderMilestonesView() {
        let content = "";
        if (state.activeMilestoneProjectId === null) {
          content = `<div class="p-6">
            <h2 class="text-2xl font-bold mb-4">Select a project to view its milestones</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${state.projects.map((p) => `<div class="bg-gray-800 p-6 rounded-xl border border-gray-700 cursor-pointer hover:border-cyan-500 milestone-project-card" data-project-id="${p.id}">
                  <h3 class="font-bold text-lg">${p.name}</h3>
                  <p class="text-sm text-gray-400">${p.milestones.length} milestones</p>
                </div>`).join("")}
            </div>
          </div>`;
        } else {
          const project = state.projects.find((p) => p.id === state.activeMilestoneProjectId);
          content = `<div class="p-6 max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6">
              <div class="flex items-center gap-4">
                <button id="backToProjectsBtn" class="text-gray-400 hover:text:white">&larr;</button>
                <div class="flex items-center gap-2">
                  <h2 class="text-2xl font-bold">${project.name} Milestones</h2>
                  <span class="info-btn text-gray-500 cursor-pointer" data-info="milestones">info</span>
                </div>
              </div>
              <button id="addMilestoneBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><span class="material-icons-outlined">add</span>New Milestone</button>
            </div>
            <div class="relative border-l-2 border-gray-700 pl-8 space-y-12">
              ${project.milestones.map((m) => createMilestoneHTML(m)).join("") || '<p class="text-gray-500">No milestones for this project yet.</p>'}
            </div>
          </div>`;
        }
        return content;
      }
      function createMilestoneHTML(m) {
        const difficultyColors = { Easy: "text-green-400", Medium: "text-yellow-400", Hard: "text-red-400" };
        const priorityColors = { Low: "bg-green-500/20", Medium: "bg-yellow-500/20", High: "bg-red-500/20" };
        return `<div class="mb-8">
          <div class="absolute -left-3.5 mt-1.5 h-6 w-6 rounded-full bg-cyan-500 border-4 border-gray-800"></div>
          <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-xl font-bold">${m.title}</h3>
                <p class="text-sm text-gray-400 mt-1">Due: ${m.dueDate || "-"}</p>
              </div>
              <div class="flex items-center gap-2 text-xs font-semibold">
                <span class="${difficultyColors[m.difficulty] || ""}">${m.difficulty}</span>
                <span class="px-2 py-1 rounded-full ${priorityColors[m.priority] || ""}">${m.priority}</span>
                <button class="edit-milestone-btn text-xs bg-gray-700 px-2 py-1 rounded" data-id="${m.id}">Edit</button>
                <button class="delete-milestone-btn text-xs bg-red-700 px-2 py-1 rounded" data-id="${m.id}">Delete</button>
              </div>
            </div>
            <p class="mt-2 text-gray-300 whitespace-pre-wrap">${m.description || ""}</p>
          </div>
        </div>`;
      }

      // ---------- Modal factories ----------
      function renderModals() {
        modalsContainer.innerHTML = "";
        if (state.isTaskModalOpen) modalsContainer.innerHTML += createTaskModalHTML();
        if (state.isTodoModalOpen) modalsContainer.innerHTML += createTodoModalHTML();
        if (state.isMoveToProjectModalOpen) modalsContainer.innerHTML += createMoveToProjectModalHTML();
        if (state.isMoveTaskModalOpen) modalsContainer.innerHTML += createMoveTaskModalHTML();
        if (state.isInfoModalOpen) modalsContainer.innerHTML += createInfoModalHTML();
        if (state.isMilestoneModalOpen) modalsContainer.innerHTML += createMilestoneModalHTML();
        if (state.isProfileModalOpen) modalsContainer.innerHTML += createProfileModalHTML();
        if (state.isAiModalOpen) modalsContainer.innerHTML += createAiModalHTML();
        if (state.isProjectModalOpen) modalsContainer.innerHTML += createProjectModalHTML();
        if (state.isShareModalOpen) modalsContainer.innerHTML += createShareModalHTML();
      }

      function createProjectModalHTML() {
        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <form id="projectForm" class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg flex flex-col border border-gray-700">
            <div class="p-6 border-b border-gray-700"><h2 class="text-2xl font-bold">Create Project</h2></div>
            <div class="p-6 space-y-4">
              <input name="name" placeholder="Project Name" class="w-full bg-gray-700 p-2 rounded-lg" required />
              <textarea name="description" placeholder="Description" class="w-full bg-gray-700 p-2 rounded-lg h-24"></textarea>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-4">
              <button type="button" class="close-modal-btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
              <button type="submit" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">Create</button>
            </div>
          </form>
        </div>`;
      }

      function createShareModalHTML() {
        const task = state.taskToShare;
        if (!task) return '';
        
        const assigneeName = getAssigneeName(task);
        const project = state.projects.find(p => p.id === state.activeProjectId);
        const projectName = project ? project.name : 'Unknown Project';
        
        const taskDetails = {
          title: task.content,
          description: task.notes || 'No description provided',
          project: projectName,
          assignee: assigneeName || 'Unassigned',
          priority: task.priority || 'Medium',
          dueDate: task.dueDate || 'No due date',
          aiCommunication: task.aiComm?.active ? 
            `${task.aiComm.frequency} (${(task.aiComm.days || []).join(', ')})` : 'Disabled',
          aiPrompt: task.aiComm?.prompt || 'No AI prompt set',
          referenceLink: task.links || 'No reference link',
          createdAt: new Date().toLocaleDateString(),
          status: 'Active'
        };

        const shareText = `📋 **Task Details**

**Title:** ${taskDetails.title}
**Project:** ${taskDetails.project}
**Assignee:** ${taskDetails.assignee}
**Priority:** ${taskDetails.priority}
**Due Date:** ${taskDetails.dueDate}
**Status:** ${taskDetails.status}

**Description:**
${taskDetails.description}

**AI Communication:** ${taskDetails.aiCommunication}
${taskDetails.aiPrompt !== 'No AI prompt set' ? `**AI Prompt:** ${taskDetails.aiPrompt}` : ''}
${taskDetails.referenceLink !== 'No reference link' ? `**Reference:** ${taskDetails.referenceLink}` : ''}

Created: ${taskDetails.createdAt}`;


      }

      function createTaskModalHTML() {
        const task = state.activeTask;
        const isNew = !task;
        const taskData = isNew ? {
          content: "", notes: "", priority: "Medium", dueDate: "",
          assigneeId: null, assignee: null, subtasks: [],
          links: "", aiComm: { active: false, frequency: "daily", days: [], prompt: "" },
        } : task;

        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-40 p-4">
          <form id="taskForm" class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col border border-gray-700">
            <div class="p-6 border-b border-gray-700"><h2 class="text-2xl font-bold">${isNew ? "Create Task" : "Edit Task"}</h2></div>
            <div class="p-6 flex-grow overflow-y-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2 space-y-4">
                <input class="w-full bg-gray-700 p-2 rounded-lg" type="text" name="content" value="${taskData.content}" placeholder="Task Title..." required>
                <textarea class="w-full bg-gray-700 p-2 rounded-lg h-24" name="notes" placeholder="Add notes...">${taskData.notes}</textarea>
                <input class="w-full bg-gray-700 p-2 rounded-lg" type="text" name="links" value="${taskData.links || ""}" placeholder="Add a link...">
                <div class="p-4 bg-gray-900/50 rounded-lg">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2"><h4 class="font-semibold">AI Automated Communication</h4><span class="info-btn text-gray-500 cursor-pointer" data-info="aiComm">info</span></div>
                    <label><div class="relative inline-block w-10 mr-2 align-middle select-none">
                      <input type="checkbox" name="ai_active" id="ai_toggle" class="toggle-checkbox w-12 h-6 transition duration-200 ease-in-out bg-gray-600 rounded-full appearance-none cursor-pointer before:absolute before:w-4 before:h-4 before:bg-white before:rounded-full before:left-1 before:top-1 before:transition-all" ${taskData.aiComm.active ? "checked" : ""}/>
                    </div></label>
                  </div>
                  <div class="${taskData.aiComm.active ? "" : "hidden"}">
                    <select class="w-full bg-gray-700 p-2 rounded-lg mb-2" name="ai_frequency"><option>daily</option><option>weekly</option></select>
                    <div class="flex gap-2 mb-2">
                      ${["Mon", "Tue", "Wed", "Thu", "Fri"].map((d) =>
          `<label class="flex items-center gap-1 text-sm"><input type="checkbox" name="ai_days" value="${d}" ${taskData.aiComm.days?.includes(d) ? "checked" : ""}> ${d}</label>`
        ).join("")}
                    </div>
                    <textarea name="ai_prompt" class="w-full bg-gray-700 p-2 rounded-lg h-20" placeholder="What should the AI ask? e.g., 'Any blockers? What's your estimated completion?'">${taskData.aiComm.prompt || ""}</textarea>
                  </div>
                </div>
              </div>
              <div class="space-y-4">
                <select name="priority" class="w-full bg-gray-700 p-2 rounded-lg">
                  ${Object.keys(priorityStyles).map((p) => `<option ${taskData.priority === p ? "selected" : ""}>${p}</option>`).join("")}
                </select>
                <input class="w-full bg-gray-700 p-2 rounded-lg" type="date" name="dueDate" value="${taskData.dueDate || ""}">
                <div class="flex gap-2">
                  <select name="assignee" class="w-full bg-gray-700 p-2 rounded-lg">
                    <option value="">Unassigned</option>
                    ${state.users.map((u) =>
          `<option value="${u.id}" ${taskData.assigneeId == u.id ? "selected" : ""}>${u.name}</option>`
        ).join("")}
                    <option value="add_new">-- Add New --</option>
                  </select>
                  <button type="button" id="aiSuggestBtn" class="bg-indigo-600 text-white font-semibold px-3 rounded">Suggest</button>
                </div>
                <div id="aiSuggestions" class="hidden bg-gray-900/40 rounded p-2 text-sm"></div>
              </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-4">
              <button type="button" class="close-modal-btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
              <button type="submit" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
          </form>
        </div>`;
      }

      function createTodoModalHTML() {
        const item = state.activeTodoItem;
        const isNew = !item;
        const data = isNew ? {
          content: "", description: "", links: "", priority: "Medium", dueDate: "", assignee: "", thingsToConsider: "", subtasks: [],
        } : item;
        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-40 p-4">
          <form id="todoForm" class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl flex flex-col border border-gray-700">
            <div class="p-6 border-b border-gray-700"><h2 class="text-2xl font-bold">${isNew ? "Add" : "Edit"} To-Do Item</h2></div>
            <div class="p-6 flex-grow space-y-4 overflow-y-auto max-h-[60vh]">
              <input type="text" name="content" value="${data.content || ""}" class="w-full text-lg font-semibold bg-gray-700 rounded-lg p-2" placeholder="Item content..." required>
              <textarea name="description" class="w-full bg-gray-700 p-2 rounded-lg h-24" placeholder="Description...">${data.description || ""}</textarea>
              <input type="text" name="links" value="${data.links || ""}" placeholder="https://example.com" class="w-full bg-gray-700 p-2 rounded-lg">
              <textarea name="thingsToConsider" class="w-full bg-gray-700 p-2 rounded-lg h-20" placeholder="Things to consider...">${data.thingsToConsider || ""}</textarea>
              <div class="grid grid-cols-2 gap-4">
                <select name="priority" class="w-full bg-gray-700 p-2 rounded-lg">
                  ${Object.keys(priorityStyles).map((p) => `<option ${data.priority === p ? "selected" : ""}>${p}</option>`).join("")}
                </select>
                <input type="date" name="dueDate" value="${data.dueDate || ""}" class="w-full bg-gray-700 p-2 rounded-lg">
              </div>
              <select name="assignee" class="w-full bg-gray-700 p-2 rounded-lg">
                <option value="">Unassigned</option>
                ${state.users.map((u) => `<option value="${u.name}" ${data.assignee === u.name ? "selected" : ""}>${u.name}</option>`).join("")}
              </select>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-4">
              <button type="button" class="close-modal-btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
              <button type="submit" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">${isNew ? "Save Item" : "Update Item"}</button>
            </div>
          </form>
        </div>`;
      }

      function createMoveTaskModalHTML() {
        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6">
              <h3 class="font-semibold mb-4">Move task to which project?</h3>
              <select id="taskProjectSelectDropdown" class="w-full bg-gray-700 p-2 rounded-lg">
                ${state.projects.filter(p => p.id !== state.activeProjectId).map((p) => `<option value="${p.id}">${p.name}</option>`).join("")}
              </select>
              <div class="flex justify-end gap-4 mt-4">
                <button type="button" class="close-modal-btn bg-gray-600 p-2 rounded-lg text-sm">Cancel</button>
                <button id="confirmTaskMoveBtn" class="bg-blue-600 p-2 rounded-lg text-sm">Confirm Move</button>
              </div>
            </div>
          </div>
        </div>`;
      }

      function createMoveToProjectModalHTML() {
        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6">
              <h3 class="font-semibold mb-4">Move todo item to which project?</h3>
              <select id="projectSelectDropdown" class="w-full bg-gray-700 p-2 rounded-lg">
                ${state.projects.map((p) => `<option value="${p.id}">${p.name}</option>`).join("")}
              </select>
              <div class="flex justify-end gap-4 mt-4">
                <button type="button" class="close-modal-btn bg-gray-600 p-2 rounded-lg text-sm">Cancel</button>
                <button id="confirmMoveBtn" class="bg-cyan-600 p-2 rounded-lg text-sm">Confirm Move</button>
              </div>
            </div>
          </div>
        </div>`;
      }

      function createInfoModalHTML() {
        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
              <h2 class="text-xl font-bold">${state.infoModalContent.title}</h2>
              <button class="close-modal-btn text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 text-gray-300 space-y-2">${state.infoModalContent.body}</div>
          </div>
        </div>`;
      }

      function createMilestoneModalHTML() {
        const milestone = state.activeMilestone;
        const isNew = !milestone;
        const data = isNew ? { title: "", description: "", dueDate: "", priority: "Medium", difficulty: "Medium" } : milestone;
        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-40 p-4">
          <form id="milestoneForm" class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg flex flex-col border border-gray-700">
            <div class="p-6 border-b border-gray-700"><h2 class="text-2xl font-bold">${isNew ? "Create" : "Edit"} Milestone</h2></div>
            <div class="p-6 flex-grow space-y-4">
              <input name="title" value="${data.title}" placeholder="Milestone Title" class="w-full bg-gray-700 p-2 rounded-lg" required>
              <textarea name="description" placeholder="Description" class="w-full bg-gray-700 p-2 rounded-lg h-24">${data.description || ""}</textarea>
              <input name="dueDate" type="date" value="${(data.dueDate || "").slice(0, 10)}" class="w-full bg-gray-700 p-2 rounded-lg">
              <div class="grid grid-cols-2 gap-4">
                <select name="priority" class="w-full bg-gray-700 p-2 rounded-lg">
                  <option ${data.priority === "Low" ? "selected" : ""}>Low</option>
                  <option ${data.priority === "Medium" ? "selected" : ""}>Medium</option>
                  <option ${data.priority === "High" ? "selected" : ""}>High</option>
                </select>
                <select name="difficulty" class="w-full bg-gray-700 p-2 rounded-lg">
                  <option ${data.difficulty === "Easy" ? "selected" : ""}>Easy</option>
                  <option ${data.difficulty === "Medium" ? "selected" : ""}>Medium</option>
                  <option ${data.difficulty === "Hard" ? "selected" : ""}>Hard</option>
                </select>
              </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-4">
              <button type="button" class="close-modal-btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
              <button type="submit" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
          </form>
        </div>`;
      }

      function createProfileModalHTML() {
        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-40 p-4">
          <form id="profileForm" class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl flex flex-col border border-gray-700" enctype="multipart/form-data">
            <div class="p-6 border-b border-gray-700"><h2 class="text-2xl font-bold">Add New Developer Profile</h2></div>
            <div class="p-6 flex-grow space-y-4 overflow-y-auto max-h-[60vh]">
              <input name="fullName" placeholder="Full Name" class="w-full bg-gray-700 p-2 rounded-lg" required>
              <input name="title" placeholder="Job Title" class="w-full bg-gray-700 p-2 rounded-lg">
              <textarea name="description" placeholder="Description..." class="w-full bg-gray-700 p-2 rounded-lg h-20"></textarea>
              <input name="email" type="email" placeholder="Email" class="w-full bg-gray-700 p-2 rounded-lg">
              <input name="phone" type="tel" placeholder="Phone ( +91 xxxxxxxxxx )" class="w-full bg-gray-700 p-2 rounded-lg">
              <input name="linkedinUrl" type="url" placeholder="LinkedIn URL" class="w-full bg-gray-700 p-2 rounded-lg">
              <input name="githubUrl" type="url" placeholder="GitHub URL" class="w-full bg-gray-700 p-2 rounded-lg">
              <input name="languages" placeholder="Coding Languages (comma-separated)" class="w-full bg-gray-700 p-2 rounded-lg">
              <textarea name="adminFeedback" placeholder="Admin Feedback..." class="w-full bg-gray-700 p-2 rounded-lg h-20"></textarea>
              <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Resume</label>
                <input name="resume" type="file" accept=".pdf,.doc,.docx"
                       class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500/10 file:text-cyan-300 hover:file:bg-cyan-500/20">
              </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-4"><button type="button" class="close-modal-btn">Cancel</button><button type="submit">Save Profile</button></div>
          </form>
        </div>`;
      }

      function createAiModalHTML() {
        let content = "";
        state.selectedTasksForAI.forEach((taskId) => {
          const task = findTaskById(taskId);
          if (!task) return;
          // Build suggestions using the same API we wired for the modal Suggest button.
          // We render a placeholder container; it will be populated after render() via fetch.
          const cid = `ai-cont-${taskId}`;
          content += `<div class="bg-gray-700 p-4 rounded-lg">
              <h4 class="font-bold text-lg">${task.content}</h4>
              <div id="${cid}" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-300">Loading suggestions...</div>
            </div>`;
        });
        return `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div class="modal-content bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold">AI Assignment Suggestions</h2><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div class="p-6 max-h-[60vh] overflow-y-auto space-y-4">${content || "<p class='text-gray-400'>No tasks selected.</p>"}</div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-4">
              <button type="button" class="close-modal-btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Close</button>
              <button id="aiAcceptAssignBtn" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg">Accept & Assign</button>
            </div>
          </div>
        </div>`;
      }

      // ---------- Drag and Drop Functionality ----------
      function setupDragAndDrop() {
        const taskCards = document.querySelectorAll('.task-card');
        const columns = document.querySelectorAll('.column');

        taskCards.forEach(task => {
          task.addEventListener('dragstart', handleDragStart);
          task.addEventListener('dragend', handleDragEnd);
        });

        columns.forEach(column => {
          column.addEventListener('dragover', handleDragOver);
          column.addEventListener('dragenter', handleDragEnter);
          column.addEventListener('dragleave', handleDragLeave);
          column.addEventListener('drop', handleDrop);
        });
      }

      function handleDragStart(e) {
        e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
        e.target.classList.add('dragging');
        setTimeout(() => {
          e.target.style.display = 'none';
        }, 0);
      }

      function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        e.target.style.display = 'block';
      }

      function handleDragOver(e) {
        e.preventDefault();
      }

      function handleDragEnter(e) {
        e.preventDefault();
        e.target.closest('.column').classList.add('drag-over');
      }

      function handleDragLeave(e) {
        e.target.closest('.column').classList.remove('drag-over');
      }

      function handleDrop(e) {
        e.preventDefault();
        const column = e.target.closest('.column');
        column.classList.remove('drag-over');

        const taskId = parseInt(e.dataTransfer.getData('text/plain'));
        const sourceColumn = document.querySelector('.task-card.dragging').closest('.column');
        const targetColumnId = parseInt(column.dataset.columnId);

        if (sourceColumn && column && sourceColumn !== column) {
          moveTaskToColumn(taskId, parseInt(sourceColumn.dataset.columnId), targetColumnId);
        }
      }

      async function moveTaskToColumn(taskId, sourceColumnId, targetColumnId) {
        const project = state.projects.find(p => p.id === state.activeProjectId);
        if (!project) return;

        const sourceColumn = project.columns.find(c => c.id === sourceColumnId);
        const targetColumn = project.columns.find(c => c.id === targetColumnId);
        if (!sourceColumn || !targetColumn) return;

        const idx = sourceColumn.tasks.findIndex(t => t.id === taskId);
        if (idx === -1) return;

        const [task] = sourceColumn.tasks.splice(idx, 1);
        targetColumn.tasks.push(task);

        // Persist status change to API
        try {
          const newApiStatus = uiToApiStatus[targetColumn.title] || "todo";
          await apiFetch(`/api/tasks/${taskId}`, {
            method: "PATCH",
            body: { status: newApiStatus },
          });
        } catch (err) {
          // rollback on error
          targetColumn.tasks.pop();
          sourceColumn.tasks.splice(idx, 0, task);
          alert(err?.data?.error || "Failed to update task status");
          return;
        }

        // keep Task Tracking Matrix in sync
        syncTaskTrackingFromProject(project);

        render();
      }


      // ---------- Export Functionality ----------
      function setupExportButtons() {
        const exportCsvBtn = document.getElementById('exportMatrixCsvBtn');
        const exportPdfBtn = document.getElementById('exportMatrixPdfBtn');
        const importCsvInput = document.getElementById('importMatrixCsvInput');

        if (exportCsvBtn) {
          exportCsvBtn.addEventListener('click', exportMatrixAsCsv);
        }
        if (exportPdfBtn) {
          exportPdfBtn.addEventListener('click', exportMatrixAsPdf);
        }
        if (importCsvInput) {
          importCsvInput.addEventListener('change', handleCsvImport);
        }
      }

      function exportMatrixAsCsv() {
        if (!state.gridData || state.gridData.length === 0) {
          alert('No data to export');
          return;
        }

        const csvContent = state.gridData.map(row => {
          return row.map(cell => {
            if (typeof cell === 'object') {
              return `"${cell.text || ''}"`;
            }
            return `"${cell}"`;
          }).join(',');
        }).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'task_matrix.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      function exportMatrixAsPdf() {
        if (!jsPDF) {
          alert('PDF library not loaded');
          return;
        }

        const table = document.getElementById('csvGridTable');
        if (!table) {
          alert('No table to export');
          return;
        }

        html2canvas(table).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p', 'mm', 'a4');
          const imgWidth = 210;
          const pageHeight = 295;
          const imgHeight = canvas.height * imgWidth / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;

          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          pdf.save('task_matrix.pdf');
        });
      }

      function handleCsvImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const csvText = e.target.result;
          const rows = csvText.split('\n').map(row => row.split(',').map(cell => {
            // Remove quotes and trim
            const cleaned = cell.replace(/^"|"$/g, '').trim();
            return { text: cleaned, color: '' };
          }));

          state.gridData = rows;
          renderCsvAsGrid(state.gridData);
        };
        reader.readAsText(file);
      }

      // ---------- Events ----------
      document.body.addEventListener("click", async (e) => {
        const target = e.target;
        const navLink = target.closest(".nav-link");
        const projectLink = target.closest(".project-link");

        // Switch active to-do list
        const listLink = target.closest("#todoListsContainer a");
        if (listLink) {
          const listId = parseInt(listLink.dataset.listId);
          state.activeTodoListId = listId;
          await loadTodoItems(listId);
          return;
        }

        if (navLink) {
          state.currentView = navLink.dataset.view;
          saveCurrentView(state.currentView);
          if (navLink.dataset.view === "milestonesView") state.activeMilestoneProjectId = null;
          render();
        }

        if (projectLink) {
          state.activeProjectId = parseInt(projectLink.dataset.projectId);
          state.currentView = "dashboardView";
          saveCurrentView(state.currentView);
          const p = state.projects.find((x) => x.id === state.activeProjectId);
          if (p && !p._tasksLoaded) await hydrateTasksForProject(p.id); else render();
        }

        // Dashboard mode switcher
        const modeBtn = target.closest(".dashboard-mode-btn");
        if (modeBtn) {
          state.dashboardMode = modeBtn.dataset.mode;
          render();
        }

        // Calendar navigation
        if (target.id === "prevMonthBtn") {
          state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
          render();
        }
        if (target.id === "nextMonthBtn") {
          state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
          render();
        }

        // To-Do Lists
        if (target.id === "addNewListBtn") {
          const name = prompt("New list name:");
          if (!name) return;
          try {
            const created = await apiFetch("/api/todos/lists", { method: "POST", body: { name } });
            state.todoLists.push({ id: created.id, name: created.name, items: [] });
            state.activeTodoListId = created.id;
            render();
          } catch (err) {
            alert(err?.data?.error || "Failed to create list");
          }
        }

        if (target.closest("#addNewTodoItemBtn")) {
          state.activeTodoItem = null;
          state.isTodoModalOpen = true;
          render();
        }

        // Click a todo card to edit
        const todoCard = target.closest("[data-item-id]");
        if (todoCard && state.currentView === "todoView") {
          const id = parseInt(todoCard.dataset.itemId);
          const list = state.todoLists.find(l => l.id === state.activeTodoListId);
          const item = list?.items.find(i => i.id === id);
          if (item) {
            state.activeTodoItem = item;
            state.isTodoModalOpen = true;
            render();
          }
        }

        // Add Task button
        if (target.id === "addTaskBtn") {
          state.isTaskModalOpen = true;
          state.activeTask = null;
          render();
        }
        // Move task to another project
        if (target.closest(".move-task-btn")) {
          state.taskToMove = parseInt(target.closest("[data-task-id]").dataset.taskId);
          state.isMoveTaskModalOpen = true;
          render();
        }

        if (target.id === "confirmTaskMoveBtn") {
          const targetProjectId = parseInt(document.getElementById("taskProjectSelectDropdown").value);
          const taskId = state.taskToMove;

          try {
            await apiFetch(`/api/tasks/${taskId}/move`, {
              method: "POST",
              body: { projectId: targetProjectId },
            });

            // Close modal and clear state
            state.isMoveTaskModalOpen = false;
            state.taskToMove = null;

            // Refresh both source and target projects
            await hydrateTasksForProject(state.activeProjectId);
            await hydrateTasksForProject(targetProjectId);

            render();
          } catch (err) {
            alert(err?.data?.error || "Failed to move task");
          }
        }

        // Move To-Do item to Project backlog
        if (target.closest(".move-to-project-btn")) {
          state.itemToMove = parseInt(target.closest("[data-item-id]").dataset.itemId);
          state.isMoveToProjectModalOpen = true; render();
        }
        if (target.id === "confirmMoveBtn") {
          const targetProjectId = parseInt(document.getElementById("projectSelectDropdown").value);
          const activeList = state.todoLists.find((l) => l.id === state.activeTodoListId);
          const idx = activeList?.items.findIndex((i) => i.id === state.itemToMove);
          if (idx === -1) return;

          const movedItem = activeList.items[idx];
          const itemId = movedItem.id;

          try {
            await apiFetch(`/api/todos/items/${itemId}/move`, {
              method: "POST",
              body: { projectId: targetProjectId },
            });

            // ✅ close ALL related modals & clear temp state
            state.isMoveToProjectModalOpen = false;
            state.isTodoModalOpen = false;      // <- this is the one in your screenshot
            state.activeTodoItem = null;
            state.itemToMove = null;

            // refresh list items
            await loadTodoItems(state.activeTodoListId);

            // make sure target project is hydrated, then add to Backlog (or re-hydrate tasks)
            let project = state.projects.find((p) => p.id === targetProjectId);
            if (project && !project._tasksLoaded) {
              await hydrateTasksForProject(project.id);
              project = state.projects.find((p) => p.id === targetProjectId);
            }

            // Don't manually add to backlog - let the API response handle it
            // The task was already created via the API call above

            // Refresh the target project's tasks to show the newly moved task
            await hydrateTasksForProject(targetProjectId);

            state.activeProjectId = targetProjectId;
            state.currentView = "dashboardView";
            saveCurrentView(state.currentView);
            render();
          } catch (err) {
            alert(err?.data?.error || "Failed to move item");
          }
        }



        // Open Create Project modal
        if (target.id === "addNewProjectBtn") { state.isProjectModalOpen = true; render(); }

        // Share modal functionality
        if (target.id === "copyTaskDetails") {
          const task = state.taskToShare;
          if (task) {
            const assigneeName = getAssigneeName(task);
            const project = state.projects.find(p => p.id === state.activeProjectId);
            const projectName = project ? project.name : 'Unknown Project';
            
            const taskText = `📋 Task Details

Title: ${task.content}
Project: ${projectName}
Assignee: ${assigneeName || 'Unassigned'}
Priority: ${task.priority || 'Medium'}
Due Date: ${task.dueDate || 'No due date'}
Status: Active

Description:
${task.notes || 'No description provided'}

AI Communication: ${task.aiComm?.active ? `${task.aiComm.frequency} (${(task.aiComm.days || []).join(', ')})` : 'Disabled'}
${task.aiComm?.prompt ? `AI Prompt: ${task.aiComm.prompt}` : ''}
${task.links ? `Reference: ${task.links}` : ''}

Created: ${new Date().toLocaleDateString()}`;

            navigator.clipboard.writeText(taskText).then(() => {
              alert('Task details copied to clipboard!');
            }).catch(() => {
              alert('Failed to copy to clipboard');
            });
          }
        }

        

        if (target.id === "exportAsText") {
          const task = state.taskToShare;
          if (task) {
            const assigneeName = getAssigneeName(task);
            const project = state.projects.find(p => p.id === state.activeProjectId);
            const projectName = project ? project.name : 'Unknown Project';
            
            const taskText = `📋 Task Details

Title: ${task.content}
Project: ${projectName}
Assignee: ${assigneeName || 'Unassigned'}
Priority: ${task.priority || 'Medium'}
Due Date: ${task.dueDate || 'No due date'}
Status: Active

Description:
${task.notes || 'No description provided'}

AI Communication: ${task.aiComm?.active ? `${task.aiComm.frequency} (${(task.aiComm.days || []).join(', ')})` : 'Disabled'}
${task.aiComm?.prompt ? `AI Prompt: ${task.aiComm.prompt}` : ''}
${task.links ? `Reference: ${task.links}` : ''}

Created: ${new Date().toLocaleDateString()}`;

            const blob = new Blob([taskText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `task-${task.content.replace(/[^a-zA-Z0-9]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }
        }

        // Close any modal
        if (target.closest(".close-modal-btn")) {
          state.isTaskModalOpen = false; state.isTodoModalOpen = false; state.isMoveToProjectModalOpen = false;
          state.isMoveTaskModalOpen = false; state.isInfoModalOpen = false; state.isMilestoneModalOpen = false;
          state.isProfileModalOpen = false; state.isAiModalOpen = false; state.isProjectModalOpen = false; 
          state.isShareModalOpen = false; state.taskToShare = null; render();
        }

        if (target.id === "aiAnalyzeBtn") { state.isAiModalOpen = true; render(); }

        // Handle AI toggle checkbox
        if (target.id === "ai_toggle") {
          const aiSection = target.closest('.bg-gray-900\\/50').querySelector('.hidden, .flex');
          if (aiSection) {
            if (target.checked) {
              aiSection.classList.remove('hidden');
              aiSection.classList.add('flex');
            } else {
              aiSection.classList.add('hidden');
              aiSection.classList.remove('flex');
            }
          }
        }

        if (target.id === "aiAcceptAssignBtn") {
          // Check which tasks have been assigned (based on state, not DOM)
          const assignmentsToMake = [];
          for (const taskId of state.selectedTasksForAI) {
            const task = findTaskById(taskId);
            if (task && task.assigneeId) { // Check if an assignee was selected for this task
              assignmentsToMake.push({ taskId: task.id, assigneeId: task.assigneeId });
            }
          }

          if (assignmentsToMake.length === 0) {
            alert('Please select at least one suggestion before accepting.');
            return;
          }

          // All assignments are already saved to database when suggestions were clicked
          // Just close the modal and refresh the UI
          state.isAiModalOpen = false;
          render();
          alert(`Applied ${assignmentsToMake.length} assignment(s) successfully!`);
        }

        if (target.id === "aiSuggestBtn") {
          const form = document.getElementById("taskForm");
          if (!form) return;
          const fd = new FormData(form);
          const title = String(fd.get("content") || "").trim();
          const description = String(fd.get("notes") || "").trim();
          if (!title) return;
          const infoEl = document.getElementById("aiSuggestions");
          if (infoEl) { infoEl.classList.remove("hidden"); infoEl.textContent = "Analyzing..."; }
          try {
            const res = await fetch('/api/ai/suggest-assignees', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title, description, topK: 3 })
            });
            const json = await res.json();
            const suggestions = json?.suggestions || [];
            const usersById = Object.fromEntries((state.users || []).map(u => [String(u.id), u]));
            if (infoEl) {
              infoEl.innerHTML = suggestions.map((s, i) => {
                const u = usersById[String(s.profileId)];
                const name = u?.name || `#${s.profileId}`;
                const titleTxt = u?.title ? ` - ${u.title}` : "";
                const skills = Array.isArray(u?.languages) && u.languages.length ? `<div class=\"text-xs text-gray-400\">${u.languages.join(', ')}</div>` : "";
                const pct = Math.round((s.score ?? 0) * 100);
                const reason = s.reason ? `<div class=\"text-xs text-gray-500\">${s.reason}</div>` : "";
                return `<div class=\"flex items-start justify-between gap-3 bg-gray-800/60 rounded p-2 cursor-pointer hover:bg-gray-700\" data-profile-id=\"${s.profileId}\" onclick=\"selectAiSuggestion(this)\">
                  <div>
                    <div class=\"font-medium\">${i + 1}. ${name}${titleTxt}</div>
                    ${skills}
                    ${reason}
                  </div>
                  <div class=\"text-gray-300\">${pct}%</div>
                </div>`;
              }).join("") || "No profiles found";
            }
            const top = suggestions[0];
            if (top) {
              const sel = form.querySelector('select[name="assignee"]');
              if (sel) { sel.value = String(top.profileId); }
            }
          } catch (err) {
            if (infoEl) infoEl.textContent = 'Failed to analyze';
          }
        }

        const taskContent = target.closest(".task-content");
        if (taskContent) {
          const taskId = parseInt(taskContent.dataset.taskId);
          const project = state.projects.find((p) => p.id === state.activeProjectId);
          for (const col of project.columns) {
            const task = col.tasks.find((t) => t.id === taskId);
            if (task) { state.activeTask = task; state.isTaskModalOpen = true; render(); break; }
          }
        }

        const infoBtn = target.closest(".info-btn");
        if (infoBtn) {
          const key = infoBtn.dataset.info;
          if (key === "milestones") state.infoModalContent = { title: "Milestone Planning Tips", body: "<p>Good milestones are S.M.A.R.T: Specific, Measurable, Achievable, Relevant, and Time-bound. They represent major achievements in your project, not small tasks.</p>" };
          if (key === "taskTracking") state.infoModalContent = { title: "Task Tracking Matrix", body: "<p>Upload a CSV to see it as a grid. You can write in any cell to update it, or right-click a cell to set a color-coded status.</p>" };
          if (key === "aiComm") state.infoModalContent = { title: "AI Automated Communication", body: "<p>When activated, the AI will automatically message the assigned developer based on your schedule to ask for updates using your custom prompt.</p>" };
          state.isInfoModalOpen = true; render();
        }

        const viewProfileBtn = target.closest(".view-profile-btn");
        if (viewProfileBtn) {
          const uid = viewProfileBtn.dataset.userId;
          state.activeProfile = state.users.find((u) => String(u.id) === String(uid));
          render();
        }

        if (target.id === "backToProfilesBtn") { state.activeProfile = null; render(); }
        if (target.id === "addNewProfileBtn") { state.isProfileModalOpen = true; state.activeProfile = null; render(); }

        // Milestones: select project to view milestones
        const milestoneProjectCard = target.closest(".milestone-project-card");
        if (milestoneProjectCard) {
          state.activeMilestoneProjectId = parseInt(milestoneProjectCard.dataset.projectId);
          const proj = state.projects.find(p => p.id === state.activeMilestoneProjectId);
          if (!proj._milestonesLoaded) { await loadMilestones(proj.id); } else { render(); }
        }
        if (target.id === "backToProjectsBtn") { state.activeMilestoneProjectId = null; render(); }

        // Milestones: open create modal
        if (target.id === "addMilestoneBtn") { state.isMilestoneModalOpen = true; state.activeMilestone = null; render(); }

        // Milestones: edit
        if (target.classList.contains("edit-milestone-btn")) {
          const id = parseInt(target.dataset.id);
          const project = state.projects.find((p) => p.id === state.activeMilestoneProjectId);
          const m = project?.milestones.find(x => x.id === id);
          if (m) {
            state.activeMilestone = m;
            state.isMilestoneModalOpen = true;
            render();
          }
        }

        // Milestones: delete
        if (target.classList.contains("delete-milestone-btn")) {
          const id = parseInt(target.dataset.id);
          if (!confirm("Are you sure you want to delete this milestone?")) return;
          try {
            await deleteMilestone(id);
            const project = state.projects.find((p) => p.id === state.activeMilestoneProjectId);
            if (project) {
              project.milestones = project.milestones.filter((x) => x.id !== id);
            }
            render();
          } catch (err) {
            alert(err?.data?.error || "Failed to delete milestone");
          }
        }
      });

      // Task checkbox for AI selection
      document.body.addEventListener("change", (e) => {
        if (e.target.matches(".task-checkbox")) {
          const taskId = parseInt(e.target.dataset.taskId);
          if (e.target.checked) state.selectedTasksForAI.add(taskId);
          else state.selectedTasksForAI.delete(taskId);
          const analyzeBtn = document.getElementById("aiAnalyzeBtn");
          if (analyzeBtn) analyzeBtn.disabled = state.selectedTasksForAI.size === 0;
        }
      });

      // ---------- FORM SUBMISSIONS ----------
      document.body.addEventListener("submit", async (e) => {
        const form = e.target;

        // Create / Edit Task
        // Create / Edit Task (persist to API + keep local aiComm config)
        if (form.id === "taskForm") {
          e.preventDefault();

          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());

          // Keep your original UI fields (aiComm etc.) in case you store them locally
          const uiTaskData = {
            content: data.content,
            notes: data.notes,
            assignee: data.assignee,
            links: data.links,
            dueDate: data.dueDate,
            priority: data.priority,
            aiComm: {
              active: data.ai_active === "on",
              frequency: data.ai_frequency,
              days: formData.getAll("ai_days"),
              prompt: data.ai_prompt
            }
          };

          // UI → API mapping for /api/tasks
          const payload = {
            projectId: state.activeProjectId,
            title: data.content,
            description: data.notes || null,
            assigneeId: data.assignee ? Number(data.assignee) : null, // <-- use numeric ID from the select
            status: "todo",
            priority: (Object.prototype.hasOwnProperty.call(uiToApiPriority, data.priority)
              ? uiToApiPriority[data.priority]
              : "medium"),
            dueDate: normalizeDateInput(data.dueDate) || null,
          };

          try {
            if (state.activeTask) {
              // PATCH existing task in DB
              await apiFetch(`/api/tasks/${state.activeTask.id}`, {
                method: "PATCH",
                body: {
                  title: payload.title,
                  description: payload.description,
                  priority: payload.priority,
                  dueDate: payload.dueDate,
                  assigneeId: payload.assigneeId,
                },
              });

              // Keep your local-only fields (like aiComm) attached to the active task
              Object.assign(state.activeTask, uiTaskData);

              // Persist AI communication settings to backend
              await apiFetch('/api/communications', {
                method: 'POST',
                body: {
                  taskId: state.activeTask.id,
                  active: uiTaskData.aiComm.active,
                  frequency: uiTaskData.aiComm.frequency,
                  days: uiTaskData.aiComm.days,
                  prompt: uiTaskData.aiComm.prompt,
                }
              });

            } else {
              // POST new task to DB
              const created = await apiFetch(`/api/tasks`, { method: "POST", body: payload });
              // Persist AI communication settings for new task
              await apiFetch('/api/communications', {
                method: 'POST',
                body: {
                  taskId: created.id,
                  active: uiTaskData.aiComm.active,
                  frequency: uiTaskData.aiComm.frequency,
                  days: uiTaskData.aiComm.days,
                  prompt: uiTaskData.aiComm.prompt,
                }
              });
            }

            // Close modal
            state.isTaskModalOpen = false;
            state.activeTask = null;

            // Send Telegram notification if task is assigned
            if (payload.assigneeId) {
              try {
                const res = await apiFetch('/api/telegram/send-message', {
                  method: 'POST',
                  body: {
                    profileId: Number(payload.assigneeId),
                    task: taskForMsg,
                    adminEmail: state.currentUser?.email || 'admin@example.com',
                    aiUrl: `${window.location.origin}/ai-assistant`
                  }
                });
                if (!res.ok) {
                  console.warn('Telegram message not sent:', res.reason || res.error);
                } else {
                  console.log('Telegram notification sent successfully');
                }
              } catch (err) {
                console.warn('Telegram send failed:', err);
              }
            }

            // Rehydrate from server (ensures board + matrix reflect DB)
            await hydrateTasksForProject(state.activeProjectId);

            render();
          } catch (err) {
            alert(err?.data?.error || "Failed to save task");
          }
        }

        // Create / Edit To-Do Item
        // Create / Edit To-Do Item
        if (form.id === "todoForm") {
          e.preventDefault();
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          const listId = state.activeTodoListId;

          // Map UI fields -> API payload
          const payload = {
            content: data.content,
            description: data.description || null,
            link: data.links || null,
            considerations: data.thingsToConsider || null,
            priority: (data.priority || "Medium"),            // your backend expects "Low|Medium|High|Urgent"
            dueDate: data.dueDate || null,
            assigneeId: data.assignee || null,
            tags: [],                                         // keep empty or map subtasks if you add that UI
            status: "open",                                   // or whatever you want as default
          };

          try {
            if (state.activeTodoItem) {
              // UPDATE existing item -> PATCH /api/todos/items/:id
              const id = state.activeTodoItem.id;
              await apiFetch(`/api/todos/items/${id}`, { method: "PATCH", body: payload });
            } else {
              // CREATE item in DB -> POST /api/todos/lists/:id/items
              await apiFetch(`/api/todos/lists/${listId}/items`, { method: "POST", body: payload });
            }

            // Close modal + refresh from server so we have real IDs
            state.isTodoModalOpen = false;
            state.activeTodoItem = null;
            await loadTodoItems(listId);
          } catch (err) {
            alert(err?.data?.error || "Failed to save item");
          }
          return;
        }

        // Create / Edit Milestone
        if (form.id === "milestoneForm") {
          e.preventDefault();
          const fd = new FormData(form);
          const data = Object.fromEntries(fd.entries());
          const payload = {
            title: data.title,
            description: data.description,
            dueDate: data.dueDate,
            priority: data.priority,
            difficulty: data.difficulty,
          };
          try {
            if (state.activeMilestone) {
              const updated = await updateMilestone(state.activeMilestone.id, payload);
              const project = state.projects.find((p) => p.id === state.activeMilestoneProjectId);
              if (project) {
                const idx = project.milestones.findIndex((m) => m.id === state.activeMilestone.id);
                if (idx !== -1) project.milestones[idx] = updated;
              }
            } else {
              const created = await createMilestone(state.activeMilestoneProjectId, payload);
              const project = state.projects.find((p) => p.id === state.activeMilestoneProjectId);
              if (project) project.milestones.push(created);
            }
            state.isMilestoneModalOpen = false;
            state.activeMilestone = null;
            // Force re-render to update milestone counts in project cards
            render();
          } catch (err) {
            alert(err?.data?.error || "Failed to save milestone");
          }
        }

        // Create Project
        if (form.id === "projectForm") {
          e.preventDefault();
          const fd = new FormData(form);
          const name = fd.get("name");
          const description = fd.get("description");
          try {
            const row = await apiFetch("/api/projects", { method: "POST", body: { name, description } });
            state.projects.push({
              id: row.id,
              name: row.name,
              description: row.description,
              columns: defaultColumns(),
              milestones: [],
              _tasksLoaded: false,
              _milestonesLoaded: false,
            });
            state.activeProjectId = row.id;
            state.isProjectModalOpen = false;
            render();
          } catch (err) {
            alert(err?.data?.error || "Failed to create project");
          }
        }

        // Create Profile
        // ----- REPLACE the existing "Create Profile" submit handler with this -----
        if (form.id === "profileForm") {
          e.preventDefault();

          // Read raw inputs
          const el = (name) => form.querySelector(`[name="${name}"]`);
          const fullName = el("fullName").value.trim();
          const title = el("title").value.trim();
          const description = el("description").value.trim();
          const email = el("email").value.trim();
          const phone = el("phone").value.trim();
          const linkedinUrl = el("linkedinUrl").value.trim();
          const githubUrl = el("githubUrl").value.trim();
          const languagesRaw = el("languages").value.trim();
          const adminFeedback = el("adminFeedback").value.trim();
          const resumeInput = el("resume");


          // Build FormData (so file upload works and server's multipart branch runs)
          const fd = new FormData();
          // If you have a logged-in user id/email, set it appropriately; null is fine too
          // fd.append("userId", String(currentUserId));
          // fd.append("userId", ""); // optional

          fd.append("fullName", fullName);
          fd.append("title", title || "");
          fd.append("description", description || "");
          fd.append("email", email || "");
          fd.append("phone", phone || "");
          fd.append("linkedinUrl", linkedinUrl || "");
          fd.append("githubUrl", githubUrl || "");

          // Your server's toLanguages() accepts JSON array OR comma-separated text.
          // We'll send JSON so it’s unambiguous.
          const languages = languagesRaw
            ? languagesRaw.split(",").map(s => s.trim()).filter(Boolean)
            : [];
          fd.append("languages", JSON.stringify(languages));

          fd.append("adminFeedback", adminFeedback || "");

          // Attach file if chosen
          if (resumeInput?.files?.[0]) {
            fd.append("resume", resumeInput.files[0]);
          }

          try {
            const created = await apiUpload("/api/profiles", fd);

            // Normalize into your UI shape
            state.users.push({
              id: created.id,
              name: created.full_name,
              title: created.title || "",
              description: created.description || "",
              email: created.email || "",
              phone: created.phone || "",
              linkedin: created.linkedin_url || "",
              github: created.github_url || "",
              languages: Array.isArray(created.languages) ? created.languages : [],
              adminFeedback: created.admin_feedback || "",
              avatar: "...",
              resumeUrl: created.resume_url || null,
            });

            state.isProfileModalOpen = false;
            render();
          } catch (err) {
            // Make Zod errors readable
            const z = err?.data?.error;
            const fieldErrs = z?.fieldErrors
              ? Object.entries(z.fieldErrors)
                .map(([k, arr]) => `${k}: ${(arr || []).join(", ")}`)
                .join("\n")
              : null;
            alert(fieldErrs || z?.formErrors?.join?.(", ") || err?.data?.error || "Failed to create profile");
          }
        }


        // Telegram API call when a new profile is created

        // Telegram notification function
        async function sendTelegramNotification(profileId, task, projectName) {
          try {
            const result = await apiFetch('/api/telegram/send-message', {
              method: 'POST',
              body: {
                profileId: profileId,
                task: {
                  id: task.id,
                  title: task.content || task.title,
                  description: task.notes || '',
                  projectName: projectName,
                  startDate: task.startDate || '',
                  endDate: task.dueDate || '',
                  priority: task.priority || 'medium',
                  referenceLink: task.links || '',
                  aiComm: {
                    active: task.ai_active || false,
                    frequency: task.ai_frequency || 'daily',
                    days: task.ai_days || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                    prompt: task.ai_prompt || ''
                  }
                },
                adminEmail: state.currentUser?.email || 'admin@example.com',
                aiUrl: `${window.location.origin}/ai-assistant`
              }
            });

            if (result.ok) {
              console.log('Telegram notification sent successfully');
              return { success: true, messageId: result.message_id };
            } else {
              console.log('Telegram notification failed:', result.reason);
              return { success: false, reason: result.reason };
            }
          } catch (error) {
            console.error('Failed to send Telegram notification:', error);
            return { success: false, error: error.message };
          }
        }
        const project = state.projects.find(p => p.id === state.activeProjectId);
        const projectName = project ? project.name : '';

        const taskForMsg = {
          // Use the currently active task id if present; otherwise leave null
          id: state.activeTask ? state.activeTask.id : null,
          title: payload.title,
          description: payload.description || '',
          projectName,
          startDate: '',                           // set if you have it
          endDate: payload.dueDate || '',
          priority: payload.priority || 'medium',
          referenceLink: payload.links || '',
          aiComm: {
            active: payload.ai_active || false,
            frequency: payload.ai_frequency || 'daily',
            days: payload.ai_days || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
            prompt: payload.ai_prompt || ''
          }
        };

        if (payload.assigneeId) {
          try {
            const res = await apiFetch('/api/telegram/send-message', {
              method: 'POST',
              body: {
                profileId: Number(payload.assigneeId),
                task: taskForMsg,
                adminEmail: state.currentUser?.email || 'admin@example.com',
                aiUrl: `${window.location.origin}/ai-assistant`
              }
            });
            if (!res.ok) {
              console.warn('Telegram message not sent:', res.reason || res.error);
              // Optional: toast user if res.reason === 'no_chat_id' to ask dev to /start + share phone
            }
          } catch (err) {
            console.warn('Telegram send failed:', err);
          }
        }

        if (result.ok) {
          console.log('Telegram message sent successfully');
        } else {
          console.log('Failed to send Telegram message:', result.reason);
        }


      });

      // Initial render


      render();
    });
  </script>
</body>

</html>